<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>早報 · Schale Intelligence Terminal v4</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════════
   DESIGN TOKENS
═══════════════════════════════════════════════ */
:root {
  --pink:        #ffaab2;
  --pink-dark:   #ff8e99;
  --pink-light:  #ffeef0;
  --pink-glow:   rgba(255,170,178,0.35);
  --blue:        #7de3f8;
  --blue-deep:   #5ab0e8;
  --blue-glow:   rgba(125,227,248,0.3);
  --teal:        #60d4c8;
  --text:        #4c5b70;
  --text-light:  #8a9bb3;
  --text-faint:  #bac8d8;
  --glass:       rgba(255,255,255,0.91);
  --glass-inner: rgba(255,255,255,0.75);
  --noise:       0.022;
  --breath:       0;
  --breath-scale: 1;
  --scan-speed:   40s;
  --t-fast: 0.18s;
  --t-mid:  0.32s;
  --t-slow: 0.55s;
}

/* ── RESET & BASE ── */
*, *::before, *::after { box-sizing: border-box; }
html, body {
  margin: 0; padding: 0;
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  user-select: none;
  touch-action: manipulation;
}
body {
  font-family: "M PLUS Rounded 1c", sans-serif;
  color: var(--text);
  background: #f0f4fa;
  min-height: 100dvh;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 16px 0 40px;
  position: relative;
  overflow-x: hidden;
}

/* ── static background mesh ── */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 80% 60% at 15% 10%, rgba(255,200,215,0.38) 0%, transparent 60%),
    radial-gradient(ellipse 60% 50% at 88% 88%, rgba(125,227,248,0.25) 0%, transparent 55%),
    radial-gradient(ellipse 50% 40% at 50% 50%, rgba(255,238,240,0.5) 0%, transparent 70%),
    linear-gradient(160deg, #eef3fa 0%, #f9f0f5 100%);
  pointer-events: none;
  z-index: 0;
}

/* ── breath saturation overlay ── */
#bg-breath-overlay {
  position: fixed; inset: 0;
  background: radial-gradient(
    ellipse 70% 60% at 30% 40%,
    rgba(255,190,210,0.5) 0%,
    rgba(200,230,255,0.3) 60%,
    transparent 100%
  );
  opacity: 0.05;
  pointer-events: none;
  z-index: 0;
  transition: opacity 0.5s ease;
  will-change: opacity;
}

/* ═══════════════════════════════════════════════
   V4 — PARTICLE DUST CANVAS
═══════════════════════════════════════════════ */
#dust-canvas {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 1;
  mix-blend-mode: screen;
}

/* ═══════════════════════════════════════════════
   SIDE STRIPS
═══════════════════════════════════════════════ */
.side-strip {
  position: fixed;
  top: 50%;
  transform: translateY(-50%);
  writing-mode: vertical-lr;
  font-size: 8px; font-weight: 700;
  letter-spacing: 3px;
  color: var(--blue); opacity: 0.14;
  pointer-events: none;
  z-index: 0;
  text-transform: uppercase;
  font-family: "JetBrains Mono", monospace;
  line-height: 1;
}
.side-strip-l { left: 6px; }
.side-strip-r { right: 6px; transform: translateY(-50%) rotate(180deg); }

/* ═══════════════════════════════════════════════
   V4 — PERSPECTIVE WRAPPER
═══════════════════════════════════════════════ */
#perspective-wrap {
  perspective: 1100px;
  perspective-origin: 50% 40%;
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  z-index: 10;
}

/* ═══════════════════════════════════════════════
   MAIN CONTAINER
═══════════════════════════════════════════════ */
.terminal {
  width: calc(100% - 24px);
  max-width: 440px;
  position: relative;
  background: var(--glass);
  backdrop-filter: blur(28px) saturate(140%);
  -webkit-backdrop-filter: blur(28px) saturate(140%);
  border-radius: 22px;
  border: 2px solid rgba(255,255,255,0.98);
  outline: 1.5px solid rgba(255,170,178,0.28);
  outline-offset: 3px;
  box-shadow:
    0 0 0 0px rgba(255,170,178,0),
    0 16px 48px rgba(255,130,148,0.15),
    0 4px 16px rgba(125,227,248,0.12),
    0 1px 3px rgba(0,0,0,0.04);
  transform-style: preserve-3d;
  will-change: box-shadow, transform, filter, backdrop-filter;
  overflow: hidden;
}

/* ── noise texture ── */
.terminal::before {
  content: ''; position: absolute; inset: 0; border-radius: 20px;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-size: 180px;
  opacity: var(--noise);
  pointer-events: none;
  z-index: 100;
  mix-blend-mode: overlay;
}

/* ── scanlines ── */
.terminal::after {
  content: ''; position: absolute; inset: 0; border-radius: 20px;
  background: repeating-linear-gradient(
    0deg,
    transparent 0px, transparent 3px,
    rgba(106,217,245,0.014) 3px, rgba(106,217,245,0.014) 4px
  );
  animation: scanMove var(--scan-speed, 40s) linear infinite;
  pointer-events: none;
  z-index: 99;
}
@keyframes scanMove { from { background-position: 0 0; } to { background-position: 0 200px; } }

.terminal.state-loading    { --scan-speed: 20s; }
.terminal.state-idle       { --scan-speed: 40s; }
.terminal.state-speaking   { --scan-speed: 12s; }
.terminal.state-processing { --scan-speed: 5s;  }
.terminal.state-standby    { --scan-speed: 65s; }

/* ── Low activity dimming ── */
.terminal[data-activity="low"] .weiyu-card,
.terminal[data-activity="low"] .player-card,
.terminal[data-activity="low"] .news-item {
  opacity: 0.92; transition: opacity 1.2s ease;
}
.terminal[data-activity="low"] .header-right { opacity: 0.85; transition: opacity 1.2s ease; }
.terminal[data-activity="normal"] .weiyu-card,
.terminal[data-activity="normal"] .player-card,
.terminal[data-activity="normal"] .news-item,
.terminal[data-activity="normal"] .header-right {
  opacity: 1; transition: opacity 0.3s ease;
}

/* ═══════════════════════════════════════════════
   STATE BADGE
═══════════════════════════════════════════════ */
.state-badge {
  position: absolute; top: 14px; right: 14px;
  font-family: "JetBrains Mono", monospace;
  font-size: 7.5px; font-weight: 700;
  letter-spacing: 2px; text-transform: uppercase;
  padding: 3px 9px; border-radius: 100px;
  z-index: 200;
  transition: background var(--t-mid), color var(--t-mid), opacity var(--t-mid);
}
.state-badge.idle       { background: rgba(125,227,248,0.18); color: var(--blue-deep); }
.state-badge.loading    { background: rgba(255,200,100,0.2);  color: #c87800; }
.state-badge.speaking   { background: rgba(255,170,178,0.25); color: var(--pink-dark); }
.state-badge.processing { background: rgba(96,212,200,0.2);   color: var(--teal); }
.state-badge.standby    { background: rgba(186,200,216,0.2);  color: var(--text-light); }

/* ═══════════════════════════════════════════════
   HEADER
═══════════════════════════════════════════════ */
.header {
  padding: 22px 20px 10px;
  display: flex; align-items: flex-start;
  justify-content: space-between;
  position: relative; z-index: 10;
}
.title-block h1 {
  margin: 0; font-size: 26px; font-weight: 800;
  font-style: italic; color: var(--text);
  letter-spacing: 0.5px;
  text-shadow: 2px 2px 0 rgba(255,255,255,0.95);
  line-height: 1.1;
}
.title-block .sub {
  font-family: "JetBrains Mono", monospace;
  font-size: 8.5px; font-weight: 700;
  letter-spacing: 2.5px; color: var(--pink-dark);
  text-transform: uppercase; margin-top: 5px; opacity: 0.85;
}
.header-right {
  display: flex; flex-direction: column;
  align-items: flex-end; gap: 6px;
  padding-right: 4px;
  transition: opacity var(--t-slow);
}
.date-pill {
  background: linear-gradient(135deg, rgba(255,255,255,0.97) 0%, rgba(255,238,240,0.9) 100%);
  padding: 5px 13px; border-radius: 100px;
  font-family: "JetBrains Mono", monospace;
  font-size: 11px; font-weight: 700; color: var(--pink-dark);
  border: 1.5px solid rgba(255,170,178,0.4);
  box-shadow: 0 2px 8px rgba(255,142,153,0.1);
  white-space: nowrap;
}
.signal-meter { display: flex; align-items: flex-end; gap: 2.5px; height: 14px; }
.signal-bar {
  width: 3px; background: var(--text-faint); border-radius: 2px;
  transition: background 0.12s ease, height 0.12s ease;
}
.signal-bar:nth-child(1) { height: 30%; }
.signal-bar:nth-child(2) { height: 55%; }
.signal-bar:nth-child(3) { height: 75%; }
.signal-bar:nth-child(4) { height: 90%; }
.signal-bar:nth-child(5) { height: 100%; }
.signal-bar.active           { background: var(--blue-deep); }
.signal-bar.processing-pulse { background: var(--teal); transition: background 0.08s, height 0.08s; }

/* ═══════════════════════════════════════════════
   CLOCK ROW
═══════════════════════════════════════════════ */
.clock-row {
  display: flex; align-items: center; gap: 6px;
  padding: 0 18px 10px;
  position: relative; z-index: 10;
}
.clock-time {
  font-family: "JetBrains Mono", monospace;
  font-size: 11px; font-weight: 700;
  color: var(--text-light); letter-spacing: 1.5px;
}
.clock-dot {
  width: 5px; height: 5px; border-radius: 50%;
  background: var(--teal); opacity: 0.7;
  animation: pulse-dot 2s ease-in-out infinite;
}
@keyframes pulse-dot {
  0%, 100% { opacity: 0.7; transform: scale(1); }
  50%       { opacity: 1;   transform: scale(1.2); }
}
.clock-sep {
  flex: 1; height: 1px;
  background: linear-gradient(90deg, rgba(186,200,216,0.3) 0%, transparent 100%);
}
.online-badge {
  font-family: "JetBrains Mono", monospace;
  font-size: 7.5px; font-weight: 700;
  letter-spacing: 1.5px; text-transform: uppercase;
  color: var(--teal); background: rgba(96,212,200,0.1);
  padding: 2px 8px; border-radius: 100px;
}

/* ═══════════════════════════════════════════════
   V4 — DISTRIBUTED TACTIC WIDGETS
═══════════════════════════════════════════════ */
.tactic-widgets {
  padding: 0px 18px 10px;
  display: flex; gap: 8px;
  position: relative; z-index: 10;
  align-items: stretch;
}
.widget {
  flex: 1;
  background: rgba(255,255,255,0.5);
  border: 1px solid rgba(186,200,216,0.32);
  border-radius: 10px;
  padding: 7px 9px;
  overflow: hidden;
  position: relative;
  min-width: 0;
}
.widget::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(125,227,248,0.4), transparent);
}
.widget-label {
  font-family: "JetBrains Mono", monospace;
  font-size: 6px; font-weight: 700;
  letter-spacing: 2px; color: var(--text-faint);
  text-transform: uppercase; margin-bottom: 4px;
}

/* Waveform widget */
.waveform-canvas {
  display: block; width: 100%; height: 26px;
}

/* Code-stream widget */
.codestream-widget { flex: 1.4; }
.codestream-scroll {
  font-family: "JetBrains Mono", monospace;
  font-size: 5.5px; color: #5ab0e8;
  opacity: 0.75; line-height: 1.45;
  height: 26px; overflow: hidden;
  position: relative;
}
.codestream-inner {
  position: absolute; top: 0; left: 0; right: 0;
  animation: code-scroll 8s linear infinite;
}
@keyframes code-scroll {
  0%   { transform: translateY(0); }
  100% { transform: translateY(-50%); }
}

/* Radar widget */
.radar-widget { flex: 0 0 auto; width: 58px; }
.radar-wrap {
  display: flex; align-items: center; justify-content: center;
  height: 26px;
}
.radar-svg { width: 30px; height: 30px; overflow: visible; }
.radar-rings { }
.radar-sweep {
  transform-origin: 50% 50%;
  animation: radar-spin 3.8s linear infinite;
}
@keyframes radar-spin {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}
.radar-cross-h, .radar-cross-v {
  stroke: rgba(96,212,200,0.25); stroke-width: 0.5;
}
.radar-blip { animation: blip-fade 3.8s linear infinite; }
@keyframes blip-fade {
  0%   { opacity: 0; }
  5%   { opacity: 0.9; }
  20%  { opacity: 0; }
  100% { opacity: 0; }
}

/* ═══════════════════════════════════════════════
   WEIYU CARD
═══════════════════════════════════════════════ */
.weiyu-wrap { padding: 4px 18px 12px; position: relative; z-index: 10; }
.weiyu-card {
  background: var(--glass-inner);
  border-left: 3.5px solid var(--pink);
  border-radius: 4px 14px 14px 4px;
  padding: 14px 15px 13px; position: relative;
  box-shadow: 0 2px 12px rgba(255,170,178,0.1), 0 1px 4px rgba(125,227,248,0.05);
  transition: box-shadow var(--t-mid), border-color var(--t-mid), opacity var(--t-slow);
  min-height: 58px;
}
.weiyu-card.speaking { border-color: var(--pink-dark); box-shadow: 0 2px 22px rgba(255,142,153,0.22), 0 1px 8px rgba(125,227,248,0.1); }
.weiyu-card.idle-nudge { box-shadow: 0 2px 24px rgba(255,170,178,0.3), 0 1px 10px rgba(125,227,248,0.15); }
.weiyu-label {
  position: absolute; top: -9px; left: 10px;
  background: var(--pink); color: white;
  font-size: 8px; padding: 2px 9px; border-radius: 4px;
  font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
  font-family: "JetBrains Mono", monospace;
  transition: background var(--t-mid), box-shadow var(--t-mid);
}
.weiyu-label.speaking  { background: var(--pink-dark); box-shadow: 0 0 10px rgba(255,142,153,0.45); }
.weiyu-label.idle-badge{ box-shadow: 0 0 10px rgba(255,170,178,0.6); }
.weiyu-text { font-size: 13px; line-height: 1.65; color: var(--text); margin: 0; min-height: 24px; }
.weiyu-cursor {
  display: inline-block; width: 1.5px; height: 14px;
  background: var(--pink-dark); margin-left: 1px;
  vertical-align: middle; animation: blink 1.1s steps(1) infinite;
}
@keyframes blink { 50% { opacity: 0; } }

/* ═══════════════════════════════════════════════
   VOICE PLAYER
═══════════════════════════════════════════════ */
.player-section {
  padding: 4px 18px 14px;
  position: relative; z-index: 10;
}
.player-card {
  background: linear-gradient(135deg, rgba(255,238,240,0.75) 0%, rgba(235,246,255,0.75) 100%);
  border: 1.5px solid rgba(255,200,210,0.45);
  border-radius: 16px; padding: 14px 16px;
  position: relative; overflow: hidden;
  box-shadow: 0 2px 12px rgba(255,170,178,0.08);
  transition: opacity var(--t-slow);
}
.player-card::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, rgba(125,227,248,0.05) 100%);
  pointer-events: none;
}
.player-row { display: flex; align-items: center; gap: 14px; }
.voice-core-wrap {
  position: relative; flex-shrink: 0;
  width: 52px; height: 52px;
  display: flex; align-items: center; justify-content: center;
}
.core-halo {
  position: absolute; border-radius: 50%;
  border: 1.5px solid rgba(255,170,178,0.3);
  transition: opacity var(--t-mid), transform var(--t-mid);
}
.halo-1 { width: 52px; height: 52px; }
.halo-2 { width: 64px; height: 64px; border-color: rgba(125,227,248,0.2); }
.halo-3 { width: 76px; height: 76px; border-color: rgba(255,170,178,0.12); }
.speaking .halo-1 { animation: halo-pulse 1.4s ease-out infinite; }
.speaking .halo-2 { animation: halo-pulse 1.4s ease-out infinite 0.3s; }
.speaking .halo-3 { animation: halo-pulse 1.4s ease-out infinite 0.6s; }
.processing .halo-1 { animation: halo-scan 1.2s ease-in-out infinite; }
.processing .halo-2 { animation: halo-scan 1.2s ease-in-out infinite 0.2s; }
@keyframes halo-pulse {
  0%   { transform: scale(1);    opacity: 0.6; }
  60%  { transform: scale(1.25); opacity: 0.15; }
  100% { transform: scale(1.4);  opacity: 0; }
}
@keyframes halo-scan {
  0%, 100% { border-color: rgba(125,227,248,0.25); }
  50%       { border-color: rgba(96,212,200,0.55); }
}
.voice-core {
  width: 44px; height: 44px; border-radius: 50%;
  background: linear-gradient(135deg, var(--pink-light) 0%, rgba(220,244,255,0.9) 100%);
  border: 2px solid rgba(255,255,255,0.9);
  box-shadow: 0 0 0 2px rgba(255,170,178,0.2), 0 4px 12px rgba(255,142,153,0.18), inset 0 1px 2px rgba(255,255,255,0.9);
  display: flex; align-items: center; justify-content: center;
  position: relative; z-index: 2;
  transition: box-shadow var(--t-mid), background var(--t-mid);
  cursor: pointer;
}
.voice-core.speaking {
  background: linear-gradient(135deg, rgba(255,200,210,0.95) 0%, rgba(200,240,255,0.9) 100%);
  box-shadow: 0 0 0 3px rgba(255,170,178,0.35), 0 0 20px rgba(255,142,153,0.3), 0 4px 14px rgba(255,142,153,0.2), inset 0 1px 2px rgba(255,255,255,0.9);
}
.voice-core.processing {
  box-shadow: 0 0 0 2px rgba(96,212,200,0.35), 0 0 16px rgba(96,212,200,0.25), 0 4px 12px rgba(125,227,248,0.2), inset 0 1px 2px rgba(255,255,255,0.9);
}
.voice-core.idle-pulse-anim { animation: idle-core-pulse 0.9s ease-out; }
@keyframes idle-core-pulse {
  0%   { box-shadow: 0 0 0 2px rgba(255,170,178,0.2), 0 4px 12px rgba(255,142,153,0.18), inset 0 1px 2px rgba(255,255,255,0.9); }
  40%  { box-shadow: 0 0 0 6px rgba(255,170,178,0.22), 0 0 24px rgba(255,142,153,0.32), inset 0 1px 2px rgba(255,255,255,0.9); }
  100% { box-shadow: 0 0 0 2px rgba(255,170,178,0.2), 0 4px 12px rgba(255,142,153,0.18), inset 0 1px 2px rgba(255,255,255,0.9); }
}
.play-icon  { width: 18px; height: 18px; fill: var(--pink-dark); transition: fill var(--t-fast); }
.pause-icon { width: 18px; height: 18px; fill: var(--pink-dark); display: none; }
.player-meta { flex: 1; min-width: 0; }
.player-title { font-size: 13px; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
.player-status {
  font-family: "JetBrains Mono", monospace;
  font-size: 9px; font-weight: 700;
  letter-spacing: 1.8px; text-transform: uppercase;
  color: var(--text-light); transition: color var(--t-mid);
}
.player-status.speaking   { color: var(--pink-dark); }
.player-status.processing { color: var(--teal); }
.progress-track {
  margin-top: 10px; height: 3px;
  background: rgba(186,200,216,0.35);
  border-radius: 100px; overflow: hidden; position: relative;
}
.progress-fill {
  height: 100%; width: 0%;
  background: linear-gradient(90deg, var(--pink) 0%, var(--blue) 100%);
  border-radius: 100px; transition: width 0.5s linear; position: relative;
}
.progress-fill::after {
  content: ''; position: absolute; right: -1px; top: 50%; transform: translateY(-50%);
  width: 5px; height: 5px; background: var(--pink-dark); border-radius: 50%;
  box-shadow: 0 0 4px rgba(255,142,153,0.6); opacity: 0; transition: opacity var(--t-fast);
}
.progress-fill.active::after { opacity: 1; }
.time-row {
  display: flex; justify-content: space-between; margin-top: 5px;
  font-family: "JetBrains Mono", monospace;
  font-size: 9px; color: var(--text-faint);
}

/* ═══════════════════════════════════════════════
   V4 — TACTICAL LINK PANEL (audio fallback)
═══════════════════════════════════════════════ */
.tactical-link-panel {
  margin: 0 18px 14px;
  background: linear-gradient(135deg, rgba(235,248,255,0.82) 0%, rgba(228,255,250,0.72) 100%);
  border: 1.5px solid rgba(96,212,200,0.28);
  border-radius: 14px; padding: 11px 14px;
  position: relative; z-index: 10;
  display: none;
}
.tlp-header {
  display: flex; align-items: center; gap: 7px; margin-bottom: 9px;
}
.tlp-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--teal); animation: pulse-dot 2s ease-in-out infinite;
}
.tlp-title {
  font-family: "JetBrains Mono", monospace;
  font-size: 7.5px; font-weight: 700;
  letter-spacing: 2px; text-transform: uppercase;
  color: var(--teal); flex: 1;
}
.tlp-ver {
  font-family: "JetBrains Mono", monospace;
  font-size: 7px; color: var(--text-faint); letter-spacing: 1px;
}
.tlp-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 3.5px 0; font-family: "JetBrains Mono", monospace;
  font-size: 9px; color: var(--text-light);
  border-bottom: 1px solid rgba(186,200,216,0.14);
}
.tlp-row:last-child { border-bottom: none; }
.tlp-key { letter-spacing: 0.5px; }
.tlp-val { font-weight: 700; color: var(--text); letter-spacing: 0.5px; }
.tlp-val.green { color: var(--teal); }
.tlp-val.blink { animation: blink 1.8s steps(1) infinite; }

/* ═══════════════════════════════════════════════
   SECTION DIVIDER
═══════════════════════════════════════════════ */
.section-head {
  padding: 4px 18px 8px;
  display: flex; align-items: center; gap: 10px;
  position: relative; z-index: 10;
}
.section-label {
  font-family: "JetBrains Mono", monospace;
  font-size: 9px; font-weight: 700;
  letter-spacing: 2.5px; text-transform: uppercase;
  color: var(--text-light); white-space: nowrap;
}
.section-line { flex: 1; height: 1px; background: linear-gradient(90deg, rgba(186,200,216,0.4) 0%, transparent 100%); }
.section-count {
  font-family: "JetBrains Mono", monospace;
  font-size: 8.5px; font-weight: 700;
  color: var(--pink); background: rgba(255,170,178,0.12);
  padding: 2px 7px; border-radius: 100px;
}

/* ═══════════════════════════════════════════════
   NEWS LIST
═══════════════════════════════════════════════ */
.news-list {
  list-style: none; margin: 0;
  padding: 0 18px 20px;
  position: relative; z-index: 10;
  display: flex; flex-direction: column; gap: 7px;
}
.news-item {
  background: var(--glass-inner);
  border: 1.5px solid rgba(255,255,255,0.9);
  border-radius: 12px; padding: 11px 13px;
  position: relative; overflow: hidden;
  transition:
    transform var(--t-fast) cubic-bezier(0.34,1.56,0.64,1),
    box-shadow var(--t-fast),
    border-color var(--t-mid),
    opacity var(--t-slow);
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  box-shadow: 0 1px 6px rgba(0,0,0,0.03);
  will-change: transform;
}

/* ── scan sweep overlay ── */
.news-item::before {
  content: ''; position: absolute; left: -100%; top: 0;
  width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent 0%, rgba(125,227,248,0.12) 40%, rgba(96,212,200,0.1) 60%, transparent 100%);
  pointer-events: none; opacity: 0;
  transition: opacity var(--t-mid);
}
.news-item::after {
  content: ''; position: absolute; left: 0; top: 0;
  width: 3px; height: 100%;
  background: transparent; border-radius: 2px 0 0 2px;
  transition: background var(--t-mid);
}
.news-item.processing-scan::before { animation: scan-sweep 1.4s ease-in-out; }
.news-item.processing-scan::after  { background: var(--teal); }
.news-item.processing-scan { border-color: rgba(96,212,200,0.3); box-shadow: 0 1px 12px rgba(96,212,200,0.12); }
@keyframes scan-sweep { 0% { left: -100%; opacity: 1; } 100% { left: 100%; opacity: 0.3; } }

/* ── V4: news item press ── */
.news-item:active, .news-item.pressed {
  transform: scale(0.975); box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}
.news-item.released {
  transform: scale(1.008); transition: transform 0.2s cubic-bezier(0.34,1.56,0.64,1);
}

/* ── V4: glitch on news item ── */
.news-item.glitch-item {
  animation: item-glitch 0.17s ease forwards;
  pointer-events: none;
}
@keyframes item-glitch {
  0%   { transform: translateX(0); filter: none; }
  18%  { transform: translateX(-4px) scaleX(0.993); filter: hue-rotate(30deg) brightness(1.09); }
  36%  { transform: translateX(3px)  scaleX(1.008); filter: hue-rotate(-25deg); }
  55%  { transform: translateX(-2px); filter: hue-rotate(12deg) saturate(1.3); }
  72%  { transform: translateX(1px); filter: none; }
  100% { transform: translateX(0);   filter: none; }
}

/* ── V4: expanded intel summary ── */
.news-main { display: flex; gap: 11px; align-items: flex-start; }
.news-summary {
  max-height: 0; overflow: hidden; opacity: 0;
  transition: max-height 0.4s cubic-bezier(0.4,0,0.2,1), opacity 0.3s ease 0.06s;
}
.news-item.expanded .news-summary { max-height: 120px; opacity: 1; }
.summary-inner {
  padding-top: 9px; margin-top: 7px;
  border-top: 1px dashed rgba(125,227,248,0.38);
}
.summary-label {
  font-family: "JetBrains Mono", monospace;
  font-size: 7px; font-weight: 700;
  letter-spacing: 2px; text-transform: uppercase;
  color: var(--teal); margin-bottom: 5px;
}
.summary-text {
  font-size: 11.5px; line-height: 1.58; color: var(--text-light);
}
.summary-classify {
  display: inline-block; margin-bottom: 4px;
  font-family: "JetBrains Mono", monospace;
  font-size: 7px; font-weight: 700;
  letter-spacing: 1.5px; text-transform: uppercase;
  background: rgba(255,170,178,0.12); color: var(--pink-dark);
  padding: 1px 6px; border-radius: 4px;
}

/* news item parts (unchanged structure) */
.news-index {
  font-family: "JetBrains Mono", monospace;
  font-size: 10px; font-weight: 700; color: var(--pink);
  min-width: 20px; padding-top: 1px; line-height: 1.4; flex-shrink: 0;
}
.news-content { font-size: 12.5px; line-height: 1.6; color: var(--text); flex: 1; }
.news-tag {
  flex-shrink: 0;
  font-family: "JetBrains Mono", monospace;
  font-size: 7.5px; font-weight: 700;
  letter-spacing: 1px; padding: 2px 7px;
  border-radius: 100px; text-transform: uppercase; margin-top: 1px;
}
.tag-tech    { background: rgba(125,227,248,0.18); color: var(--blue-deep); }
.tag-world   { background: rgba(96,212,200,0.15);  color: #2ba89e; }
.tag-finance { background: rgba(255,200,100,0.18); color: #c87800; }
.tag-sci     { background: rgba(180,160,255,0.18); color: #7050d0; }
.tag-health  { background: rgba(255,170,178,0.2);  color: var(--pink-dark); }

/* ═══════════════════════════════════════════════
   PAGINATION
═══════════════════════════════════════════════ */
.pagination {
  padding: 0 18px 16px;
  display: flex; align-items: center; justify-content: center; gap: 10px;
  position: relative; z-index: 10;
}
.page-btn {
  width: 34px; height: 34px; border-radius: 50%;
  border: 1.5px solid rgba(255,170,178,0.35);
  background: var(--glass-inner);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; position: relative; overflow: hidden;
  transition: transform var(--t-fast) cubic-bezier(0.34,1.56,0.64,1), box-shadow var(--t-fast), border-color var(--t-mid), opacity var(--t-mid);
  -webkit-tap-highlight-color: transparent;
  flex-shrink: 0;
}
.page-btn svg { width: 14px; height: 14px; fill: var(--pink-dark); pointer-events: none; }
.page-btn:active, .page-btn.pressed { transform: scale(0.88); box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
.page-btn.released { transform: scale(1.1); transition: transform 0.22s cubic-bezier(0.34,1.56,0.64,1); }
.page-btn.disabled { opacity: 0.28; pointer-events: none; }
.page-dots { display: flex; align-items: center; gap: 6px; flex: 1; justify-content: center; }
.page-dot {
  height: 6px; width: 6px; border-radius: 100px;
  background: rgba(186,200,216,0.5);
  transition: background var(--t-mid), width var(--t-mid), box-shadow var(--t-mid);
}
.page-dot.active { background: var(--pink); width: 18px; box-shadow: 0 0 6px rgba(255,142,153,0.4); }
.page-label {
  font-family: "JetBrains Mono", monospace;
  font-size: 9px; font-weight: 700;
  letter-spacing: 1.5px; color: var(--text-faint);
  white-space: nowrap; min-width: 44px; text-align: center;
}
.news-list.exit-prev  { animation: exitPrev  0.2s cubic-bezier(0.4,0,1,1) forwards; }
.news-list.exit-next  { animation: exitNext  0.2s cubic-bezier(0.4,0,1,1) forwards; }
.news-list.enter-prev { animation: enterPrev 0.28s cubic-bezier(0,0,0.2,1) forwards; }
.news-list.enter-next { animation: enterNext 0.28s cubic-bezier(0,0,0.2,1) forwards; }
@keyframes exitNext  { to { opacity: 0; transform: translateX(-22px); } }
@keyframes exitPrev  { to { opacity: 0; transform: translateX(22px); } }
@keyframes enterNext { from { opacity: 0; transform: translateX(22px); } to { opacity: 1; transform: none; } }
@keyframes enterPrev { from { opacity: 0; transform: translateX(-22px); } to { opacity: 1; transform: none; } }

/* ═══════════════════════════════════════════════
   FOOTER NAV
═══════════════════════════════════════════════ */
.footer-nav {
  padding: 10px 18px 14px;
  display: flex; justify-content: space-between; align-items: center;
  border-top: 1px solid rgba(186,200,216,0.2);
  position: relative; z-index: 10;
}
.nav-btn {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  cursor: default; pointer-events: none;
  padding: 4px 8px; border-radius: 10px;
  -webkit-tap-highlight-color: transparent;
}
.nav-icon { width: 22px; height: 22px; fill: var(--text-faint); transition: fill var(--t-fast); }
.nav-btn.active .nav-icon  { fill: var(--pink-dark); }
.nav-label {
  font-family: "JetBrains Mono", monospace;
  font-size: 7.5px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase;
  color: var(--text-faint); transition: color var(--t-fast);
}
.nav-btn.active .nav-label { color: var(--pink-dark); }
.nav-btn.active { position: relative; }
.nav-btn.active::after {
  content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 4px; height: 4px; background: var(--pink); border-radius: 50%;
}

/* ═══════════════════════════════════════════════
   LOADING SCREEN
═══════════════════════════════════════════════ */
.loading-screen {
  position: absolute; inset: 0; border-radius: 22px;
  background: rgba(255,255,255,0.96);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 500; gap: 16px;
  transition: opacity 0.5s ease;
}
.loading-screen.done { opacity: 0; pointer-events: none; }
.load-ring-wrap { position: relative; width: 54px; height: 54px; }
.load-ring {
  position: absolute; inset: 0; border-radius: 50%;
  border: 2.5px solid transparent; border-top-color: var(--pink);
  animation: spin 1s linear infinite;
}
.load-ring-2 { inset: 6px; border-top-color: var(--blue); animation: spin 1.4s linear infinite reverse; }
@keyframes spin { to { transform: rotate(360deg); } }
.load-center { position: absolute; inset: 14px; background: linear-gradient(135deg, var(--pink-light) 0%, rgba(220,244,255,0.9) 100%); border-radius: 50%; }
.load-text { font-family: "JetBrains Mono", monospace; font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--text-light); }
.load-dots::after { content: ''; animation: dots 1.2s steps(4, end) infinite; }
@keyframes dots {
  0%  { content: ''; }   25% { content: '.'; }
  50% { content: '..'; } 75% { content: '...'; }
}

/* ═══════════════════════════════════════════════
   GLITCH (terminal-level)
═══════════════════════════════════════════════ */
.glitch-active {
  animation: glitch 0.14s cubic-bezier(0.25,0.46,0.45,0.94);
  filter: hue-rotate(12deg) contrast(1.05) !important;
}
@keyframes glitch {
  0%   { clip-path: inset(20% 0 78% 0); transform: translate(-1px, 0.5px) scale(var(--breath-scale)); }
  25%  { clip-path: inset(60% 0 14% 0); transform: translate(1px, -0.5px) scale(var(--breath-scale)); }
  50%  { clip-path: inset(40% 0 50% 0); transform: translate(-1px, 1px) scale(var(--breath-scale)); }
  75%  { clip-path: inset(75% 0 10% 0); transform: translate(0.5px,-0.5px) scale(var(--breath-scale)); }
  100% { clip-path: inset(0 0 0 0);     transform: translate(0) scale(var(--breath-scale)); }
}

/* ═══════════════════════════════════════════════
   REVEAL
═══════════════════════════════════════════════ */
.reveal-item { opacity: 0; transform: translateY(8px); transition: opacity 0.4s ease, transform 0.4s ease; }
.reveal-item.visible { opacity: 1; transform: translateY(0); }

/* ═══════════════════════════════════════════════
   TOUCH RIPPLE
═══════════════════════════════════════════════ */
.ripple {
  position: absolute; border-radius: 50%;
  background: rgba(255,170,178,0.2);
  transform: scale(0);
  animation: ripple-anim 0.35s ease-out forwards;
  pointer-events: none;
}
@keyframes ripple-anim { to { transform: scale(2.5); opacity: 0; } }
</style>
</head>
<body>

<div id="bg-breath-overlay"></div>

<!-- Ambient particle dust -->
<canvas id="dust-canvas"></canvas>

<div class="side-strip side-strip-l">SCHALE INTEL · TACTICAL BRIEF · KIVOTOS</div>
<div class="side-strip side-strip-r">AUTHORIZED · SENSEI ONLY · CONFIDENTIAL</div>

<!-- Perspective wrapper for holographic tilt effect -->
<div id="perspective-wrap">

<div class="terminal state-loading" id="terminal" data-activity="normal">

  <div class="loading-screen" id="loading-screen">
    <div class="load-ring-wrap">
      <div class="load-ring"></div>
      <div class="load-ring load-ring-2"></div>
      <div class="load-center"></div>
    </div>
    <div class="load-text">INTEL DECODE<span class="load-dots"></span></div>
  </div>

  <div class="state-badge idle" id="state-badge">IDLE</div>

  <!-- HEADER -->
  <div class="header reveal-item">
    <div class="title-block">
      <h1>早報</h1>
      <div class="sub">Schale Intelligence · Daily Brief</div>
    </div>
    <div class="header-right">
      <div class="date-pill" id="date-display">Loading…</div>
      <div class="signal-meter" id="signal-meter">
        <div class="signal-bar"></div>
        <div class="signal-bar active"></div>
        <div class="signal-bar active"></div>
        <div class="signal-bar active"></div>
        <div class="signal-bar active"></div>
      </div>
    </div>
  </div>

  <!-- CLOCK ROW -->
  <div class="clock-row reveal-item" style="transition-delay:0.05s">
    <div class="clock-time" id="clock-time">00:00</div>
    <div class="clock-dot"></div>
    <div class="clock-sep"></div>
    <div class="online-badge">ONLINE</div>
  </div>

  <!-- V4 — DISTRIBUTED TACTICAL NODE WIDGETS -->
  <div class="tactic-widgets reveal-item" style="transition-delay:0.08s">
    <!-- A: Dynamic Waveform -->
    <div class="widget">
      <div class="widget-label">SYS.LOAD</div>
      <canvas class="waveform-canvas" id="waveform-canvas"></canvas>
    </div>
    <!-- B: Scrolling code stream -->
    <div class="widget codestream-widget">
      <div class="widget-label">DECODE.STREAM</div>
      <div class="codestream-scroll" id="codestream-scroll">
        <div class="codestream-inner" id="codestream-inner"></div>
      </div>
    </div>
    <!-- C: Quadrant scanner -->
    <div class="widget radar-widget">
      <div class="widget-label">SCAN</div>
      <div class="radar-wrap">
        <svg class="radar-svg" viewBox="0 0 30 30">
          <!-- rings -->
          <circle class="radar-rings" cx="15" cy="15" r="12" fill="none" stroke="rgba(125,227,248,0.2)" stroke-width="0.7"/>
          <circle cx="15" cy="15" r="8"  fill="none" stroke="rgba(125,227,248,0.15)" stroke-width="0.5"/>
          <circle cx="15" cy="15" r="4"  fill="none" stroke="rgba(125,227,248,0.12)" stroke-width="0.4"/>
          <!-- static cross -->
          <line class="radar-cross-h" x1="3" y1="15" x2="27" y2="15" stroke="rgba(96,212,200,0.2)" stroke-width="0.5"/>
          <line class="radar-cross-v" x1="15" y1="3"  x2="15"  y2="27" stroke="rgba(96,212,200,0.2)" stroke-width="0.5"/>
          <!-- sweep arm -->
          <g class="radar-sweep">
            <line x1="15" y1="15" x2="15" y2="3.5" stroke="rgba(96,212,200,0.75)" stroke-width="0.9" stroke-linecap="round"/>
            <circle cx="15" cy="4.2" r="0.9" fill="rgba(255,170,178,0.9)" class="radar-blip"/>
          </g>
          <!-- center dot -->
          <circle cx="15" cy="15" r="1.1" fill="rgba(96,212,200,0.7)"/>
        </svg>
      </div>
    </div>
  </div>

  <!-- WEIYU CARD -->
  <div class="weiyu-wrap reveal-item" style="transition-delay:0.1s">
    <div class="weiyu-card" id="weiyu-card">
      <div class="weiyu-label" id="weiyu-label">MomoTalk · AI</div>
      <p class="weiyu-text" id="weiyu-text"><span class="weiyu-cursor"></span></p>
    </div>
  </div>

  <!-- VOICE PLAYER -->
  <div class="player-section reveal-item" style="transition-delay:0.15s" id="audio-wrapper">
    <div class="player-card">
      <div class="player-row">
        <div class="voice-core-wrap">
          <div class="halo-3 core-halo"></div>
          <div class="halo-2 core-halo"></div>
          <div class="halo-1 core-halo"></div>
          <div class="voice-core" id="voice-core" role="button" aria-label="Play / Pause">
            <svg class="play-icon" id="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            <svg class="pause-icon" id="pause-icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
          </div>
        </div>
        <div class="player-meta">
          <div class="player-title">Schale 战术早报 · 情报播报</div>
          <div class="player-status" id="player-status">READY</div>
          <div class="progress-track">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <div class="time-row">
            <span id="time-current">0:00</span>
            <span id="time-total">0:00</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- V4 — TACTICAL LINK PANEL (shown when audio unavailable) -->
  <div class="tactical-link-panel reveal-item" id="tactical-link-panel" style="transition-delay:0.15s">
    <div class="tlp-header">
      <div class="tlp-dot"></div>
      <div class="tlp-title">KIVOTOS · LINK STATUS</div>
      <div class="tlp-ver">v4.0</div>
    </div>
    <div class="tlp-row"><span class="tlp-key">全境连接状态</span><span class="tlp-val green">● GREEN</span></div>
    <div class="tlp-row"><span class="tlp-key">战术节点</span><span class="tlp-val blink">7 / 7 ONLINE</span></div>
    <div class="tlp-row"><span class="tlp-key">数据完整性</span><span class="tlp-val">99.8%</span></div>
    <div class="tlp-row"><span class="tlp-key">加密协议</span><span class="tlp-val">AES-SCHALE</span></div>
    <div class="tlp-row"><span class="tlp-key">最后同步</span><span class="tlp-val" id="tlp-sync-time">--:--</span></div>
  </div>

  <!-- NEWS SECTION -->
  <div class="section-head reveal-item" style="transition-delay:0.2s">
    <div class="section-label">Intelligence Report</div>
    <div class="section-line"></div>
    <div class="section-count" id="news-count">·/·</div>
  </div>

  <ul class="news-list reveal-item" id="news-list" style="transition-delay:0.25s"></ul>

  <!-- PAGINATION -->
  <div class="pagination reveal-item" id="pagination" style="transition-delay:0.28s">
    <button class="page-btn disabled" id="page-prev" aria-label="上一页">
      <svg viewBox="0 0 24 24"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6z"/></svg>
    </button>
    <div class="page-dots" id="page-dots"></div>
    <div class="page-label" id="page-label">1 / 1</div>
    <button class="page-btn disabled" id="page-next" aria-label="下一页">
      <svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
    </button>
  </div>

  <!-- FOOTER NAV -->
  <div class="footer-nav reveal-item" style="transition-delay:0.3s">
    <div class="nav-btn active">
      <svg class="nav-icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      <div class="nav-label">早報</div>
    </div>
    <div class="nav-btn">
      <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>
      <div class="nav-label">情報</div>
    </div>
    <div class="nav-btn">
      <svg class="nav-icon" viewBox="0 0 24 24"><path d="M20 6h-2.18c.07-.44.18-.88.18-1.36C18 2.09 15.91 0 13.36 0c-1.3 0-2.51.52-3.36 1.36L9 2.36 7.99 1.35C7.14.51 5.94 0 4.64 0 2.09 0 0 2.09 0 4.64c0 .48.1.92.18 1.36H0v2h20V6zm-7.82-4c.66 0 1.29.26 1.76.73l.73.73H10.34l.72-.72C11.53 2.26 12.16 2 12.18 2zM4 8v13h16V8H4zm8 9l-4-4h2.5v-4h3v4H16l-4 4z"/></svg>
      <div class="nav-label">歸檔</div>
    </div>
    <div class="nav-btn">
      <svg class="nav-icon" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94s-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.6-.22l-2.39.96a7.15 7.15 0 00-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.488.488 0 00-.6.22L2.74 8.87a.478.478 0 00.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32a.48.48 0 00-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
      <div class="nav-label">設定</div>
    </div>
  </div>

</div><!-- .terminal -->
</div><!-- #perspective-wrap -->

<audio id="audio-source" preload="metadata" crossorigin="anonymous"></audio>

<script>
/* ═══════════════════════════════════════════════════
   SCHALE INTELLIGENCE TERMINAL  v4
   "去中心化生命感" — Decentralized Liveness
   
   New Systems (v4):
   ┌─────────────────────────────────────────────┐
   │  ParticleEngine  — ambient dust canvas      │
   │  TiltEngine      — holographic parallax     │
   │  WidgetEngine    — waveform+code+radar      │
   │  DataShred       — glitch-expand news       │
   │  TacticalLink    — audio-absent fallback    │
   └─────────────────────────────────────────────┘
═══════════════════════════════════════════════════ */

const CONFIG = {
  api:           './data.json',
  cacheKey:      'schale_intel_v4',
  standbyDelay:  60000,
  lowActivityMs: 5000,
  idleNudgeMin:  40000,
  idleNudgeMax:  90000,
};

const DEMO = {
  date: new Date().toLocaleDateString('zh-CN', { month:'long', day:'numeric', weekday:'short' }),
  weiyu: '早上好，老师。今天的情报已就绪，请查阅。基沃托斯目前状态稳定，Schale 持续监测中。',
  audio: null,
  news: [
    { text: '全球 AI 研究机构联合发布新一代多模态基准测试，涵盖视觉推理与代码生成能力评估。', tag: 'tech' },
    { text: '国际能源署报告显示，2025年可再生能源装机容量首次超过化石燃料总量。', tag: 'world' },
    { text: '量子计算公司宣布实现 1000 量子比特稳定运行，商业应用窗口或提前至明年。', tag: 'sci' },
    { text: '亚太科技股集体回暖，半导体板块单日涨幅领跑，市场情绪转向乐观。', tag: 'finance' },
    { text: '新型纳米抗体药物临床三期数据公布，对多种耐药菌显示出显著抑制效果。', tag: 'health' },
    { text: '基沃托斯联合委员会就学院间协作框架达成初步共识，细节将于本周正式公布。', tag: 'world' },
  ]
};

/* ─────────────────────────────────────────────
   TILT STATE  (shared between TiltEngine & BreathEngine)
───────────────────────────────────────────── */
const _tilt = { rx: 0, ry: 0 };

/* ═══════════════════════════════════════════════
   STATE MACHINE
═══════════════════════════════════════════════ */
const FSM = (() => {
  let _state = 'LOADING';
  const _listeners = [];
  const STATES = ['IDLE','LOADING','SPEAKING','PROCESSING','STANDBY'];
  const BREATH = {
    IDLE:       { hz: 1/7,    depth: 0.0024, shadowAmp: 0.65 },
    LOADING:    { hz: 0,      depth: 0,      shadowAmp: 0    },
    SPEAKING:   { hz: 1/5.5,  depth: 0.0030, shadowAmp: 1.0  },
    PROCESSING: { hz: 1/7,    depth: 0.0022, shadowAmp: 0.85 },
    STANDBY:    { hz: 1/14,   depth: 0.0012, shadowAmp: 0.30 },
  };
  return {
    get state()     { return _state; },
    get breathCfg() { return BREATH[_state]; },
    transition(next) {
      if (!STATES.includes(next) || next === _state) return;
      const prev = _state; _state = next;
      _listeners.forEach(fn => fn(next, prev));
    },
    on(fn) { _listeners.push(fn); }
  };
})();

/* ═══════════════════════════════════════════════
   BREATH ENGINE  (v4: includes tilt in transform)
═══════════════════════════════════════════════ */
const BreathEngine = (() => {
  let _phase = 0, _raf = null, _lastT = null;
  let _paused = false, _pausedRaw = 0.5;

  function getTerm() { return document.getElementById('terminal'); }

  function tick(t) {
    if (!_lastT) _lastT = t;
    const dt = Math.min((t - _lastT) / 1000, 0.1);
    _lastT = t;

    const cfg  = FSM.breathCfg;
    const term = getTerm();

    if (!_paused && cfg.hz > 0) _phase += dt * cfg.hz * Math.PI * 2;

    const raw   = _paused ? _pausedRaw : (Math.sin(_phase) + 1) / 2;
    const isLow = term && term.dataset.activity === 'low';
    const dMult = isLow ? 0.45 : 1.0;

    const scale       = 1 + raw * cfg.depth * dMult;
    const shadowBloom = raw * cfg.shadowAmp * (isLow ? 0.5 : 1.0);

    if (term) {
      term.style.setProperty('--breath', raw.toFixed(4));
      term.style.setProperty('--breath-scale', scale.toFixed(5));

      /* V4: combine scale + tilt into one transform */
      const rx = _tilt.rx.toFixed(2);
      const ry = _tilt.ry.toFixed(2);
      term.style.transform = `perspective(1100px) rotateX(${rx}deg) rotateY(${ry}deg) scale(${scale.toFixed(5)})`;

      term.style.boxShadow = [
        `0 0 0 ${(shadowBloom * 7).toFixed(1)}px rgba(255,170,178,${(shadowBloom * 0.10).toFixed(3)})`,
        `0 16px 48px rgba(255,130,148,${(0.12 + shadowBloom * 0.06).toFixed(3)})`,
        `0 4px 16px rgba(125,227,248,${(0.08 + shadowBloom * 0.06).toFixed(3)})`,
        '0 1px 3px rgba(0,0,0,0.04)',
      ].join(',');

      const bfSat = (130 + raw * 15).toFixed(0);
      term.style.backdropFilter       = `blur(28px) saturate(${bfSat}%)`;
      term.style.webkitBackdropFilter = `blur(28px) saturate(${bfSat}%)`;

      const stateBright  = parseFloat(term.style.getPropertyValue('--state-bright')  || '1');
      const stateSat     = parseFloat(term.style.getPropertyValue('--state-sat')      || '1');
      const neuralBright = parseFloat(term.style.getPropertyValue('--neural-bright')  || '1');
      const breathSat    = 1 + raw * 0.018;
      term.style.filter  = `brightness(${(stateBright * neuralBright).toFixed(4)}) saturate(${(stateSat * breathSat).toFixed(3)})`;
    }

    const overlay = document.getElementById('bg-breath-overlay');
    if (overlay) {
      const oAmp = isLow ? 0.03 : 0.06;
      overlay.style.opacity = (0.035 + raw * oAmp).toFixed(3);
    }

    _raf = requestAnimationFrame(tick);
  }

  return {
    start() { if (_raf) return; _raf = requestAnimationFrame(tick); },
    stop()  { if (_raf) { cancelAnimationFrame(_raf); _raf = null; _lastT = null; } },
    pauseFor(ms) {
      _pausedRaw = (Math.sin(_phase) + 1) / 2;
      _paused = true;
      setTimeout(() => { _paused = false; }, ms);
    }
  };
})();

/* ═══════════════════════════════════════════════
   V4 — TILT ENGINE
   Desktop: mouse parallax  |  Mobile: gyroscope
═══════════════════════════════════════════════ */
const TiltEngine = (() => {
  const MAX = 4.5;
  let tx = 0, ty = 0; // targets
  let cx = 0, cy = 0; // current (lerped)
  let raf = null;

  function lerp(a, b, t) { return a + (b - a) * t; }

  function tick() {
    cx = lerp(cx, tx, 0.055);
    cy = lerp(cy, ty, 0.055);
    _tilt.rx = cx;
    _tilt.ry = cy;
    raf = requestAnimationFrame(tick);
  }

  return {
    init() {
      const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

      if (isMobile && window.DeviceOrientationEvent) {
        /* Request permission on iOS 13+ */
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          document.addEventListener('touchstart', function askPerm() {
            DeviceOrientationEvent.requestPermission().catch(() => {});
            document.removeEventListener('touchstart', askPerm);
          }, { once: true });
        }
        window.addEventListener('deviceorientation', (e) => {
          if (e.gamma === null) return;
          /* gamma: left/right tilt (-90..90), beta: front/back (-180..180) */
          ty = Math.max(-MAX, Math.min(MAX, e.gamma * 0.18));
          tx = Math.max(-MAX, Math.min(MAX, (e.beta - 30) * 0.10));
        }, { passive: true });
      } else {
        /* Desktop: map mouse to viewport */
        window.addEventListener('mousemove', (e) => {
          const hw = window.innerWidth / 2;
          const hh = window.innerHeight / 2;
          ty =  ((e.clientX - hw) / hw) * MAX;
          tx = -((e.clientY - hh) / hh) * MAX;
        }, { passive: true });
        window.addEventListener('mouseleave', () => { tx = 0; ty = 0; }, { passive: true });
      }

      raf = requestAnimationFrame(tick);
    }
  };
})();

/* ═══════════════════════════════════════════════
   V4 — PARTICLE DUST ENGINE
   Ambient fine particles, scroll-reactive
═══════════════════════════════════════════════ */
const ParticleEngine = (() => {
  let canvas, ctx, particles = [];
  let scrollVY = 0, lastScrollY = 0;
  let raf = null;
  const COUNT = 55;

  function resize() {
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;
  }

  function make() {
    return {
      x: Math.random() * (canvas.width || window.innerWidth),
      y: Math.random() * (canvas.height || window.innerHeight),
      vx: (Math.random() - 0.5) * 0.28,
      vy: -(0.12 + Math.random() * 0.22),
      r:  0.55 + Math.random() * 1.1,
      op: 0.03 + Math.random() * 0.07,
      life: Math.random(), // start at random phase
      dr: 0.0018 + Math.random() * 0.0012,
    };
  }

  function tick() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    scrollVY *= 0.90;

    for (let i = 0; i < particles.length; i++) {
      const p = particles[i];
      p.x += p.vx + (Math.sin(p.life * 3.1) * 0.08);
      p.y += p.vy + scrollVY * 0.06;
      p.life -= p.dr;

      if (p.life <= 0 || p.y < -8 || p.x < -8 || p.x > canvas.width + 8) {
        particles[i] = make();
        particles[i].y = p.y < -8 ? canvas.height + 5 : particles[i].y;
        continue;
      }

      const alpha = p.op * Math.min(p.life * 3, 1);
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      /* Warm light dust: mostly white-blue, occasional pink */
      const warm = p.r > 1.3;
      ctx.fillStyle = warm
        ? `rgba(255,200,215,${alpha * 0.9})`
        : `rgba(190,225,255,${alpha})`;
      ctx.fill();
    }

    raf = requestAnimationFrame(tick);
  }

  return {
    init() {
      canvas = document.getElementById('dust-canvas');
      ctx    = canvas.getContext('2d');
      resize();
      window.addEventListener('resize', resize, { passive: true });

      window.addEventListener('scroll', () => {
        const dy   = window.scrollY - lastScrollY;
        scrollVY   = dy * 0.55;
        lastScrollY = window.scrollY;
      }, { passive: true });

      particles = Array.from({ length: COUNT }, make);
      raf = requestAnimationFrame(tick);
    }
  };
})();

/* ═══════════════════════════════════════════════
   V4 — WIDGET ENGINE
   Drives all three tactical node widgets
═══════════════════════════════════════════════ */
const WidgetEngine = (() => {
  /* ── A: Waveform ── */
  let wCanvas, wCtx;
  let wPhase = 0;
  let wLoad  = 0.55; // fake system load 0..1

  function waveformTick(t) {
    if (!wCanvas) return;
    const W = wCanvas.width;
    const H = wCanvas.height;
    wCtx.clearRect(0, 0, W, H);

    wPhase += 0.04;
    /* Gentle drift in load */
    wLoad += (Math.random() - 0.495) * 0.012;
    wLoad  = Math.max(0.15, Math.min(0.9, wLoad));

    /* Draw filled area */
    wCtx.beginPath();
    wCtx.moveTo(0, H);
    for (let x = 0; x <= W; x++) {
      const t2 = x / W;
      const y1 = Math.sin(t2 * Math.PI * 3.2 + wPhase) * 0.28;
      const y2 = Math.sin(t2 * Math.PI * 7.1 - wPhase * 1.4) * 0.12;
      const y3 = Math.sin(t2 * Math.PI * 1.8 + wPhase * 0.6) * wLoad * 0.35;
      const yf = 0.5 + y1 + y2 + y3;
      wCtx.lineTo(x, H - yf * H * 0.85);
    }
    wCtx.lineTo(W, H);
    wCtx.closePath();

    const grad = wCtx.createLinearGradient(0, 0, 0, H);
    grad.addColorStop(0,   'rgba(125,227,248,0.55)');
    grad.addColorStop(0.5, 'rgba(96,212,200,0.28)');
    grad.addColorStop(1,   'rgba(125,227,248,0.05)');
    wCtx.fillStyle = grad;
    wCtx.fill();

    /* Draw line */
    wCtx.beginPath();
    for (let x = 0; x <= W; x++) {
      const t2 = x / W;
      const y1 = Math.sin(t2 * Math.PI * 3.2 + wPhase) * 0.28;
      const y2 = Math.sin(t2 * Math.PI * 7.1 - wPhase * 1.4) * 0.12;
      const y3 = Math.sin(t2 * Math.PI * 1.8 + wPhase * 0.6) * wLoad * 0.35;
      const yf = 0.5 + y1 + y2 + y3;
      const px  = H - yf * H * 0.85;
      x === 0 ? wCtx.moveTo(x, px) : wCtx.lineTo(x, px);
    }
    wCtx.strokeStyle = 'rgba(96,212,200,0.85)';
    wCtx.lineWidth   = 1.2;
    wCtx.stroke();

    requestAnimationFrame(waveformTick);
  }

  /* ── B: Code stream ── */
  const HEX_CHARS = '0123456789ABCDEF';
  const CODE_WORDS = ['0xC4FF','AUTH','SYNC','0x3A1B','KIVOTOS','DECODE','0xFF80','SCH4LE','INTEL','0x7E2A'];

  function buildCodeStream() {
    const inner = document.getElementById('codestream-inner');
    if (!inner) return;
    let rows = '';
    // build enough rows to fill 2x height for seamless loop
    for (let i = 0; i < 18; i++) {
      let line = '';
      for (let j = 0; j < 5; j++) {
        if (Math.random() > 0.55) {
          line += CODE_WORDS[Math.floor(Math.random() * CODE_WORDS.length)] + ' ';
        } else {
          for (let k = 0; k < 4; k++) line += HEX_CHARS[Math.floor(Math.random() * 16)];
          line += ' ';
        }
      }
      rows += line.trim() + '\n';
    }
    // duplicate for seamless scroll
    inner.textContent = rows + rows;
  }

  return {
    init() {
      /* Waveform */
      wCanvas = document.getElementById('waveform-canvas');
      if (wCanvas) {
        /* Size canvas to element */
        const dpr = window.devicePixelRatio || 1;
        const rect = wCanvas.getBoundingClientRect();
        wCanvas.width  = Math.round((rect.width  || 80) * dpr);
        wCanvas.height = Math.round((rect.height || 26) * dpr);
        wCtx = wCanvas.getContext('2d');
        wCtx.scale(dpr, dpr);
        requestAnimationFrame(waveformTick);
      }

      /* Code stream */
      buildCodeStream();
      // Refresh every 12s for variety
      setInterval(buildCodeStream, 12000);
    }
  };
})();

/* ═══════════════════════════════════════════════
   STATE REACTIONS
═══════════════════════════════════════════════ */
FSM.on((state, prev) => {
  const term    = document.getElementById('terminal');
  const badge   = document.getElementById('state-badge');
  const vcore   = document.getElementById('voice-core');
  const vwrap   = document.querySelector('.voice-core-wrap');
  const wcard   = document.getElementById('weiyu-card');
  const wlabel  = document.getElementById('weiyu-label');
  const pstatus = document.getElementById('player-status');

  term.classList.remove('state-idle','state-loading','state-speaking','state-processing','state-standby');
  term.classList.add(`state-${state.toLowerCase()}`);

  const FILTERS = {
    IDLE:       { bright: 1.00, sat: 1.00 },
    LOADING:    { bright: 0.92, sat: 0.85 },
    SPEAKING:   { bright: 1.00, sat: 1.00 },
    PROCESSING: { bright: 1.00, sat: 1.00 },
    STANDBY:    { bright: 0.97, sat: 0.92 },
  };
  const f = FILTERS[state] || FILTERS.IDLE;
  term.style.setProperty('--state-bright', f.bright);
  term.style.setProperty('--state-sat',    f.sat);

  badge.className   = `state-badge ${state.toLowerCase()}`;
  badge.textContent = state;

  vcore.classList.remove('speaking', 'processing');
  vwrap && vwrap.classList.remove('speaking', 'processing');
  wcard.classList.remove('speaking');
  wlabel.classList.remove('speaking');
  pstatus.classList.remove('speaking', 'processing');

  switch(state) {
    case 'LOADING':    BreathEngine.stop(); break;
    case 'IDLE':
      BreathEngine.start();
      pstatus.textContent = 'READY';
      SignalRhythm.stopSpeaking(); SignalRhythm.startIdle();
      break;
    case 'SPEAKING':
      BreathEngine.start();
      vcore.classList.add('speaking'); vwrap && vwrap.classList.add('speaking');
      wcard.classList.add('speaking'); wlabel.classList.add('speaking');
      pstatus.classList.add('speaking'); pstatus.textContent = 'BROADCASTING';
      SignalRhythm.stopIdle(); SignalRhythm.startSpeaking();
      break;
    case 'PROCESSING':
      BreathEngine.start(); BreathEngine.pauseFor(1000);
      vcore.classList.add('processing'); vwrap && vwrap.classList.add('processing');
      pstatus.classList.add('processing'); pstatus.textContent = 'PROCESSING';
      SignalRhythm.stopSpeaking(); SignalRhythm.triggerStorm();
      break;
    case 'STANDBY':
      BreathEngine.start();
      pstatus.textContent = 'STANDBY';
      SignalRhythm.stopSpeaking(); SignalRhythm.stopIdle();
      break;
  }
});

/* ═══════════════════════════════════════════════
   NEURAL REFLEX
═══════════════════════════════════════════════ */
const NeuralReflex = (() => {
  let _timer = null;
  function activate() {
    clearTimeout(_timer);
    const term = document.getElementById('terminal');
    if (term) term.style.setProperty('--neural-bright', '1.010');
  }
  function release() {
    clearTimeout(_timer);
    _timer = setTimeout(() => {
      const term = document.getElementById('terminal');
      if (term) term.style.setProperty('--neural-bright', '1.000');
    }, 80);
  }
  return {
    bind() {
      const term = document.getElementById('terminal');
      if (!term) return;
      term.addEventListener('touchstart',  activate, { passive: true });
      term.addEventListener('touchend',    release,  { passive: true });
      term.addEventListener('touchcancel', release,  { passive: true });
      term.addEventListener('mousedown',   activate, { passive: true });
      term.addEventListener('mouseup',     release,  { passive: true });
      term.addEventListener('mouseleave',  release,  { passive: true });
    }
  };
})();

/* ═══════════════════════════════════════════════
   LOW ACTIVITY
═══════════════════════════════════════════════ */
const LowActivity = (() => {
  let _timer = null, _active = false;
  function enter() {
    if (_active || FSM.state !== 'IDLE') return;
    _active = true;
    const term = document.getElementById('terminal');
    if (term) term.dataset.activity = 'low';
  }
  function exit() {
    if (!_active) return;
    _active = false;
    const term = document.getElementById('terminal');
    if (term) term.dataset.activity = 'normal';
  }
  function reset() {
    exit(); clearTimeout(_timer);
    if (FSM.state === 'IDLE') _timer = setTimeout(enter, CONFIG.lowActivityMs);
  }
  return {
    reset, exit,
    init() {
      ['touchstart','click','keydown','mousemove','scroll'].forEach(evt => {
        document.addEventListener(evt, reset, { passive: true });
      });
    }
  };
})();

/* ═══════════════════════════════════════════════
   SIGNAL RHYTHM
═══════════════════════════════════════════════ */
const SignalRhythm = (() => {
  const BASE_HEIGHTS = [30, 55, 75, 90, 100];
  let _speakTimer = null, _idleTimer = null, _stormTimer = null, _stormRuns = 0;
  function getBars() { return document.querySelectorAll('.signal-bar'); }
  function restoreHeights() {
    getBars().forEach(b => { b.style.height = ''; b.classList.remove('processing-pulse'); });
  }
  function startSpeaking() {
    if (_speakTimer) return;
    let t = 0;
    _speakTimer = setInterval(() => {
      if (FSM.state !== 'SPEAKING') { stopSpeaking(); return; }
      t += 0.22;
      const primary = (Math.sin(t) + 1) / 2;
      const flutter = (Math.sin(t * 2.8 + 1) + 1) / 2 * 0.35;
      const energy  = primary * 0.65 + flutter;
      const activeN = Math.max(2, Math.round(energy * 5));
      getBars().forEach((b, i) => {
        b.classList.remove('active', 'processing-pulse');
        if (i < activeN) b.classList.add('active');
        const h = BASE_HEIGHTS[i] + Math.sin(t * (1.4 + i * 0.4)) * 8;
        b.style.height = `${Math.max(18, Math.min(100, h)).toFixed(1)}%`;
      });
    }, 90);
  }
  function stopSpeaking() {
    if (_speakTimer) { clearInterval(_speakTimer); _speakTimer = null; }
    restoreHeights();
    getBars().forEach(b => b.classList.remove('active'));
    [0,1,2,3,4].forEach((_, i) => { if (i > 0) getBars()[i]?.classList.add('active'); });
  }
  function startIdle() {
    if (_idleTimer) return;
    _idleTimer = setInterval(() => {
      if (FSM.state !== 'IDLE' && FSM.state !== 'STANDBY') { stopIdle(); return; }
      const bars = getBars();
      bars.forEach((b, i) => {
        if (i === 0) return;
        if (Math.random() > 0.72) b.classList.toggle('active');
        else if (i > 0) b.classList.add('active');
      });
    }, 1000);
  }
  function stopIdle() { if (_idleTimer) { clearInterval(_idleTimer); _idleTimer = null; } }
  function triggerStorm() {
    if (_stormTimer) return;
    _stormRuns = 0;
    _stormTimer = setInterval(() => {
      if (FSM.state !== 'PROCESSING' || _stormRuns > 24) {
        clearInterval(_stormTimer); _stormTimer = null;
        restoreHeights();
        getBars().forEach(b => b.classList.remove('processing-pulse'));
        [0,1,2,3,4].forEach((_, i) => { if (i > 0) getBars()[i]?.classList.add('active'); });
        return;
      }
      getBars().forEach(b => {
        b.classList.remove('active');
        b.classList.toggle('processing-pulse', Math.random() > 0.4);
        b.style.height = `${20 + Math.random() * 80}%`;
      });
      _stormRuns++;
    }, 170);
  }
  return { startSpeaking, stopSpeaking, startIdle, stopIdle, triggerStorm };
})();

/* ═══════════════════════════════════════════════
   IDLE NUDGE
═══════════════════════════════════════════════ */
let _idleNudgeTimer = null, _standbyTimer = null;
function resetIdleTimers() {
  if (_idleNudgeTimer) clearTimeout(_idleNudgeTimer);
  if (_standbyTimer)   clearTimeout(_standbyTimer);
  if (FSM.state === 'STANDBY') FSM.transition('IDLE');

  _idleNudgeTimer = setTimeout(() => {
    if (FSM.state !== 'IDLE') return;
    const core  = document.getElementById('voice-core');
    const wcard = document.getElementById('weiyu-card');
    const wlbl  = document.getElementById('weiyu-label');
    if (core)  { core.classList.add('idle-pulse-anim'); setTimeout(() => core.classList.remove('idle-pulse-anim'), 1000); }
    if (wcard) { wcard.classList.add('idle-nudge'); wlbl.classList.add('idle-badge'); setTimeout(() => { wcard.classList.remove('idle-nudge'); wlbl.classList.remove('idle-badge'); }, 2000); }
    resetIdleTimers();
  }, CONFIG.idleNudgeMin + Math.random() * (CONFIG.idleNudgeMax - CONFIG.idleNudgeMin));

  _standbyTimer = setTimeout(() => {
    if (FSM.state === 'IDLE') FSM.transition('STANDBY');
  }, CONFIG.standbyDelay);
}
['touchstart','click','keydown','mousemove'].forEach(evt => {
  document.addEventListener(evt, resetIdleTimers, { passive: true });
});

/* ═══════════════════════════════════════════════
   CLOCK
═══════════════════════════════════════════════ */
function startClock() {
  function tick() {
    const now = new Date();
    const el  = document.getElementById('clock-time');
    if (el) el.textContent = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    /* Update TLP sync time */
    const ts = document.getElementById('tlp-sync-time');
    if (ts) ts.textContent = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  }
  tick();
  setInterval(tick, 1000);
}

/* ═══════════════════════════════════════════════
   TYPEWRITER
═══════════════════════════════════════════════ */
function typeWriter(el, text, done) {
  el.innerHTML = '<span class="weiyu-cursor"></span>';
  let i = 0;
  const cursor = el.querySelector('.weiyu-cursor');
  function step() {
    if (i <= text.length) {
      el.textContent = text.slice(0, i);
      el.appendChild(cursor); i++;
      setTimeout(step, 36);
    } else { done && done(); }
  }
  step();
}

/* ═══════════════════════════════════════════════
   TOUCH FEEDBACK
═══════════════════════════════════════════════ */
function applyTouchFeedback(el) {
  let _pressing = false, _relTimer = null;
  function press(e) {
    _pressing = true;
    el.classList.remove('released'); el.classList.add('pressed');
    const rect  = el.getBoundingClientRect();
    const touch = e.changedTouches ? e.changedTouches[0] : e;
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    const size = Math.max(rect.width, rect.height);
    const r = document.createElement('div');
    r.className = 'ripple';
    r.style.cssText = `width:${size}px;height:${size}px;left:${x - size/2}px;top:${y - size/2}px`;
    el.appendChild(r);
    setTimeout(() => r.remove(), 400);
  }
  function release() {
    if (!_pressing) return;
    _pressing = false;
    el.classList.remove('pressed'); el.classList.add('released');
    if (_relTimer) clearTimeout(_relTimer);
    _relTimer = setTimeout(() => el.classList.remove('released'), 250);
  }
  el.addEventListener('touchstart',  press,   { passive: true });
  el.addEventListener('touchend',    release, { passive: true });
  el.addEventListener('touchcancel', release, { passive: true });
  el.addEventListener('mousedown',   press,   { passive: true });
  el.addEventListener('mouseup',     release, { passive: true });
}

/* ═══════════════════════════════════════════════
   AUDIO SYSTEM
═══════════════════════════════════════════════ */
let _audioCtx = null, _analyser = null, _source = null, _vizRaf = null;

function initAudio() {
  if (_audioCtx) return;
  try {
    _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    _analyser = _audioCtx.createAnalyser();
    _analyser.fftSize = 64;
    _analyser.connect(_audioCtx.destination);
    const audio = document.getElementById('audio-source');
    _source = _audioCtx.createMediaElementSource(audio);
    _source.connect(_analyser);
  } catch(e) { console.warn('[Audio]', e); }
}

function startVizLoop() {
  if (!_analyser || _vizRaf) return;
  const buf = new Uint8Array(_analyser.frequencyBinCount);
  function loop() {
    _analyser.getByteFrequencyData(buf);
    const energy = buf.slice(0, 8).reduce((a,b) => a+b, 0) / (8 * 255);
    const core = document.getElementById('voice-core');
    if (core && FSM.state === 'SPEAKING') {
      const glow  = 4 + energy * 22;
      const bloom = 4 + energy * 14;
      core.style.boxShadow = [
        `0 0 0 ${(3 + energy * 5).toFixed(1)}px rgba(255,170,178,${(0.2 + energy * 0.25).toFixed(2)})`,
        `0 0 ${glow.toFixed(1)}px rgba(255,142,153,${(0.2 + energy * 0.35).toFixed(2)})`,
        `0 4px ${bloom.toFixed(1)}px rgba(255,142,153,0.2)`,
        'inset 0 1px 2px rgba(255,255,255,0.9)',
      ].join(',');
    }
    _vizRaf = requestAnimationFrame(loop);
  }
  loop();
}

function stopVizLoop() {
  if (_vizRaf) { cancelAnimationFrame(_vizRaf); _vizRaf = null; }
  const core = document.getElementById('voice-core');
  if (core) core.style.boxShadow = '';
}

function formatTime(s) {
  const m = Math.floor(s / 60);
  return `${m}:${String(Math.floor(s % 60)).padStart(2,'0')}`;
}

function togglePlay() {
  initAudio();
  if (_audioCtx?.state === 'suspended') _audioCtx.resume().catch(()=>{});
  const audio  = document.getElementById('audio-source');
  const playI  = document.getElementById('play-icon');
  const pauseI = document.getElementById('pause-icon');

  if (!audio.src || audio.src === window.location.href) {
    if (FSM.state !== 'PROCESSING' && FSM.state !== 'SPEAKING') {
      playI.style.display = 'none'; pauseI.style.display = 'block';
      FSM.transition('PROCESSING'); triggerScanHighlight();
      setTimeout(() => {
        FSM.transition('SPEAKING');
        setTimeout(() => {
          FSM.transition('IDLE');
          playI.style.display = 'block'; pauseI.style.display = 'none';
          clearScanHighlight();
        }, 4000);
      }, 3000);
    } else {
      FSM.transition('IDLE');
      playI.style.display = 'block'; pauseI.style.display = 'none';
      clearScanHighlight();
    }
    return;
  }

  if (audio.paused) {
    triggerGlitch();
    audio.play().then(() => {
      FSM.transition('SPEAKING');
      playI.style.display = 'none'; pauseI.style.display = 'block';
      startVizLoop(); triggerScanHighlight();
    }).catch(()=>{});
  } else {
    audio.pause();
    FSM.transition('IDLE');
    playI.style.display = 'block'; pauseI.style.display = 'none';
    stopVizLoop(); clearScanHighlight();
  }
}

/* ═══════════════════════════════════════════════
   SCAN HIGHLIGHT
═══════════════════════════════════════════════ */
let _scanIdx = 0, _scanTimer = null;
function triggerScanHighlight() {
  const items = document.querySelectorAll('.news-item');
  if (!items.length) return;
  _scanIdx = 0; clearScanHighlight();
  function next() {
    if (_scanIdx >= items.length) {
      setTimeout(() => { clearScanHighlight(); if (FSM.state === 'PROCESSING') FSM.transition('SPEAKING'); }, 400);
      return;
    }
    if (_scanIdx > 0) items[_scanIdx - 1].classList.remove('processing-scan');
    items[_scanIdx].classList.add('processing-scan');
    _scanIdx++;
    _scanTimer = setTimeout(next, 680);
  }
  next();
}
function clearScanHighlight() {
  if (_scanTimer) { clearTimeout(_scanTimer); _scanTimer = null; }
  document.querySelectorAll('.news-item').forEach(el => el.classList.remove('processing-scan'));
}

/* ═══════════════════════════════════════════════
   GLITCH
═══════════════════════════════════════════════ */
function triggerGlitch() {
  const t = document.getElementById('terminal');
  t.classList.add('glitch-active');
  setTimeout(() => t.classList.remove('glitch-active'), 180);
}

/* ═══════════════════════════════════════════════
   V4 — DATA SHRED: glitch + expand news item
═══════════════════════════════════════════════ */
function triggerDataShred(li) {
  if (FSM.state === 'STANDBY' || FSM.state === 'LOADING') return;
  if (li.classList.contains('glitch-item')) return; // debounce

  const wasExpanded = li.classList.contains('expanded');

  /* Phase 1: glitch flash */
  li.classList.add('glitch-item', 'processing-scan');

  setTimeout(() => {
    li.classList.remove('glitch-item', 'processing-scan');

    /* Phase 2: toggle expand */
    if (wasExpanded) {
      li.classList.remove('expanded');
    } else {
      /* Collapse any other open items */
      document.querySelectorAll('.news-item.expanded').forEach(other => {
        if (other !== li) other.classList.remove('expanded');
      });
      li.classList.add('expanded');
    }
  }, 180);
}

/* Generate a tactical summary snippet from news text */
function makeSummary(text) {
  const shortened = text.length > 48 ? text.slice(0, 48) + '…' : text;
  const classify  = ['[CONFIRMED]','[VERIFIED]','[HIGH-CONF]','[LIVE]'][Math.floor(Math.random() * 4)];
  return { label: '核心摘要 · INTEL DECODED', classify, text: shortened };
}

/* ═══════════════════════════════════════════════
   AUDIO EVENTS
═══════════════════════════════════════════════ */
(function bindAudioEvents() {
  const audio = document.getElementById('audio-source');
  audio.addEventListener('timeupdate', () => {
    const pct  = audio.duration ? (audio.currentTime / audio.duration) * 100 : 0;
    const fill = document.getElementById('progress-fill');
    fill.style.width = pct + '%';
    pct > 1 ? fill.classList.add('active') : fill.classList.remove('active');
    document.getElementById('time-current').textContent = formatTime(audio.currentTime);
    document.getElementById('time-total').textContent   = formatTime(audio.duration || 0);
  });
  audio.addEventListener('ended', () => {
    document.getElementById('play-icon').style.display  = 'block';
    document.getElementById('pause-icon').style.display = 'none';
    document.getElementById('progress-fill').style.width = '0%';
    stopVizLoop(); clearScanHighlight(); FSM.transition('IDLE');
  });
  audio.addEventListener('error', () => {
    /* V4: audio unavailable — show tactical link panel, hide player */
    document.getElementById('audio-wrapper').style.display = 'none';
    const tlp = document.getElementById('tactical-link-panel');
    if (tlp) { tlp.style.display = 'block'; tlp.classList.add('visible'); }
  });
})();

/* ═══════════════════════════════════════════════
   PAGINATOR
═══════════════════════════════════════════════ */
const Paginator = (() => {
  const PER_PAGE = 5;
  let _data = [], _page = 0, _busy = false;

  function totalPages() { return Math.ceil(_data.length / PER_PAGE); }

  /* V4: build items with .news-main wrapper + .news-summary expand zone */
  function buildItems(pageIdx) {
    const list  = document.getElementById('news-list');
    list.innerHTML = '';
    const slice = _data.slice(pageIdx * PER_PAGE, pageIdx * PER_PAGE + PER_PAGE);
    slice.forEach((item, i) => {
      const globalIdx = pageIdx * PER_PAGE + i;
      const li        = document.createElement('li');
      li.className    = 'news-item';
      li.setAttribute('role', 'button');

      const summary = makeSummary(item.text);
      li.innerHTML = `
        <div class="news-main">
          <div class="news-index">${String(globalIdx + 1).padStart(2,'0')}</div>
          <div class="news-content">${item.text}</div>
          <div class="news-tag tag-${item.tag}">${item.tag.toUpperCase()}</div>
        </div>
        <div class="news-summary">
          <div class="summary-inner">
            <div class="summary-label">${summary.label}</div>
            <span class="summary-classify">${summary.classify}</span>
            <div class="summary-text">${summary.text}</div>
          </div>
        </div>`;

      applyTouchFeedback(li);
      li.addEventListener('click', () => triggerDataShred(li));
      list.appendChild(li);
    });
  }

  function buildAll() {
    const list = document.getElementById('news-list');
    list.innerHTML = '';
    _data.forEach((item, i) => {
      const li = document.createElement('li');
      li.className = 'news-item';
      li.setAttribute('role', 'button');
      const summary = makeSummary(item.text);
      li.innerHTML = `
        <div class="news-main">
          <div class="news-index">${String(i + 1).padStart(2,'0')}</div>
          <div class="news-content">${item.text}</div>
          <div class="news-tag tag-${item.tag}">${item.tag.toUpperCase()}</div>
        </div>
        <div class="news-summary">
          <div class="summary-inner">
            <div class="summary-label">${summary.label}</div>
            <span class="summary-classify">${summary.classify}</span>
            <div class="summary-text">${summary.text}</div>
          </div>
        </div>`;
      applyTouchFeedback(li);
      li.addEventListener('click', () => triggerDataShred(li));
      list.appendChild(li);
    });
  }

  function updateControls() {
    const pages = totalPages();
    const prev  = document.getElementById('page-prev');
    const next  = document.getElementById('page-next');
    const label = document.getElementById('page-label');
    const dots  = document.getElementById('page-dots');
    prev.classList.toggle('disabled', _page === 0);
    next.classList.toggle('disabled', _page >= pages - 1);
    label.textContent = `${_page + 1} / ${pages}`;
    dots.innerHTML = '';
    for (let i = 0; i < pages; i++) {
      const d = document.createElement('div');
      d.className = 'page-dot' + (i === _page ? ' active' : '');
      dots.appendChild(d);
    }
  }

  function goTo(newPage, dir) {
    if (_busy) return;
    const pages = totalPages();
    if (newPage < 0 || newPage >= pages) return;
    _busy = true;
    const list    = document.getElementById('news-list');
    const exitCls = dir > 0 ? 'exit-next' : 'exit-prev';
    list.classList.add(exitCls);
    setTimeout(() => {
      list.classList.remove(exitCls);
      _page = newPage; buildItems(_page); updateControls();
      const enterCls = dir > 0 ? 'enter-next' : 'enter-prev';
      list.classList.add(enterCls);
      list.addEventListener('animationend', () => {
        list.classList.remove(enterCls); _busy = false;
      }, { once: true });
    }, 200);
  }

  function isMobile() { return window.innerWidth < 600 || /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent); }

  function bindBtns() {
    const prev = document.getElementById('page-prev');
    const next = document.getElementById('page-next');
    const np = prev.cloneNode(true), nn = next.cloneNode(true);
    prev.replaceWith(np); next.replaceWith(nn);
    applyTouchFeedback(np); applyTouchFeedback(nn);
    np.addEventListener('click', () => goTo(_page - 1, -1));
    nn.addEventListener('click', () => goTo(_page + 1, +1));
  }

  let _resizeTimer = null;
  window.addEventListener('resize', () => {
    clearTimeout(_resizeTimer);
    _resizeTimer = setTimeout(() => { if (_data.length) init(_data); }, 250);
  });

  function init(data) {
    _data = data; _page = 0; _busy = false;
    if (isMobile()) {
      const pages = totalPages();
      document.getElementById('pagination').style.display = pages <= 1 ? 'none' : 'flex';
      buildItems(0); updateControls(); bindBtns();
    } else {
      document.getElementById('pagination').style.display = 'none';
      buildAll();
    }
  }
  return { init };
})();

/* ═══════════════════════════════════════════════
   RENDER UI
═══════════════════════════════════════════════ */
function renderUI(data) {
  const dateEl = document.getElementById('date-display');
  if (dateEl) dateEl.textContent = data.date || DEMO.date;

  const TAG_MAP = [
    { re: /科技|AI|芯片|机器人|大模型|电池|量子|航天|卫星|软件/, tag: 'tech' },
    { re: /财经|经济|股|基金|房|楼市|金融|市场|收入|月入|消费/, tag: 'finance' },
    { re: /健康|医|药|疫|病|研究|实验|临床/,                    tag: 'health' },
    { re: /科学|物理|化学|生物|天文|发现|突破/,                  tag: 'sci' },
  ];
  function guessTag(t) { for (const { re, tag } of TAG_MAP) if (re.test(t)) return tag; return 'world'; }

  const newsData = (data.news || []).map(item => {
    const str   = typeof item === 'string' ? item : (item.text || '');
    const clean = str.replace(/^\d+[、．.]\s*/, '').trim();
    return { text: clean, tag: guessTag(clean) };
  });

  const countEl = document.getElementById('news-count');
  if (countEl) countEl.textContent = `${newsData.length}件`;

  Paginator.init(newsData);

  const weiyuEl = document.getElementById('weiyu-text');
  const txt = (data.weiyu || DEMO.weiyu).replace(/^【微语】\s*/, '');
  typeWriter(weiyuEl, txt, () => {});

  const audio     = document.getElementById('audio-source');
  const audioWrap = document.getElementById('audio-wrapper');
  const tlp       = document.getElementById('tactical-link-panel');

  if (data.audio) {
    audio.src = data.audio;
    audioWrap.style.display = 'block';
    if (tlp) tlp.style.display = 'none';
  } else {
    /* V4: No audio → show tactical link panel instead */
    audioWrap.style.display = 'none';
    if (tlp) { tlp.style.display = 'block'; }
  }

  const loadScreen = document.getElementById('loading-screen');
  loadScreen.classList.add('done');
  setTimeout(() => { loadScreen.style.display = 'none'; }, 600);

  FSM.transition('IDLE');
  resetIdleTimers();
  LowActivity.reset();

  document.querySelectorAll('.reveal-item').forEach((el, i) => {
    setTimeout(() => el.classList.add('visible'), 300 + i * 80);
  });

  /* V4: init widget engine after layout is complete */
  setTimeout(() => WidgetEngine.init(), 350);
}

/* ═══════════════════════════════════════════════
   INIT
═══════════════════════════════════════════════ */
async function init() {
  startClock();
  document.getElementById('date-display').textContent = DEMO.date;

  /* V4 new systems */
  ParticleEngine.init();
  TiltEngine.init();

  NeuralReflex.bind();
  LowActivity.init();

  const vcore = document.getElementById('voice-core');
  applyTouchFeedback(vcore);
  vcore.addEventListener('click', togglePlay);

  BreathEngine.start();

  try {
    const cached = localStorage.getItem(CONFIG.cacheKey);
    if (cached) renderUI(JSON.parse(cached));

    const res  = await fetch(`${CONFIG.api}?t=${Date.now()}`);
    if (!res.ok) throw new Error('API unavailable');
    const json = await res.json();
    const d    = (json.success !== undefined && json.data) ? json.data : (json.data || json);
    localStorage.setItem(CONFIG.cacheKey, JSON.stringify(d));
    renderUI(d);
  } catch(e) {
    console.info('[Schale v4] Using demo data.', e);
    renderUI(DEMO);
  }
}

/* Page visibility */
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    BreathEngine.stop(); stopVizLoop();
  } else {
    if (FSM.state !== 'LOADING') BreathEngine.start();
    if (FSM.state === 'SPEAKING') startVizLoop();
  }
});

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
