<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>早報 · Schale Intelligence Terminal v5</title>
<style>
/* ═══════════════════════════════════════════════
   DESIGN TOKENS
═══════════════════════════════════════════════ */
:root {
  --pink:        #ffaab2;
  --pink-dark:   #ff8e99;
  --pink-light:  #ffeef0;
  --pink-glow:   rgba(255,170,178,0.35);
  --blue:        #7de3f8;
  --blue-deep:   #5ab0e8;
  --blue-glow:   rgba(125,227,248,0.3);
  --teal:        #60d4c8;
  --text:        #4c5b70;
  --text-light:  #8a9bb3;
  --text-faint:  #bac8d8;
  --glass:       rgba(255,255,255,0.91);
  --glass-inner: rgba(255,255,255,0.75);
  --noise:       0.022;
  --breath:      0;
  --breath-scale:1;
  --scan-speed:  40s;
  --t-fast:      0.18s;
  --t-mid:       0.32s;
  --t-slow:      0.55s;

  /* V5: Tag resonance tint (HSL hue for overlay) */
  --resonance-h:     210;
  --resonance-s:     80%;
  --resonance-l:     75%;
  --resonance-alpha: 0;

  /* V5: Rubber-band transform */
  --rubber-ty: 0px;
}

*, *::before, *::after { box-sizing: border-box; }
html, body {
  margin: 0; padding: 0;
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  user-select: none;
  touch-action: manipulation;
}
body {
  font-family: "M PLUS Rounded 1c", "Hiragino Sans", "Yu Gothic", sans-serif;
  color: var(--text);
  background: #f0f4fa;
  min-height: 100dvh;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 16px 0 40px;
  position: relative;
  overflow-x: hidden;
}

/* static background mesh */
body::before {
  content: '';
  position: fixed; inset: 0;
  background:
    radial-gradient(ellipse 80% 60% at 15% 10%, rgba(255,200,215,0.38) 0%, transparent 60%),
    radial-gradient(ellipse 60% 50% at 88% 88%, rgba(125,227,248,0.25) 0%, transparent 55%),
    radial-gradient(ellipse 50% 40% at 50% 50%, rgba(255,238,240,0.5) 0%, transparent 70%),
    linear-gradient(160deg, #eef3fa 0%, #f9f0f5 100%);
  pointer-events: none; z-index: 0;
}

/* breath overlay */
#bg-breath-overlay {
  position: fixed; inset: 0;
  background: radial-gradient(
    ellipse 70% 60% at 30% 40%,
    rgba(255,190,210,0.5) 0%,
    rgba(200,230,255,0.3) 60%,
    transparent 100%
  );
  opacity: 0.05; pointer-events: none; z-index: 0;
  transition: opacity 0.5s ease; will-change: opacity;
}

/* ── V5: Focus mode background dimming layer ── */
#focus-veil {
  position: fixed; inset: 0;
  background: rgba(230,235,245,0.0);
  pointer-events: none; z-index: 2;
  transition: background 0.35s ease;
}
.terminal.focus-mode ~ #focus-veil,
body.focus-mode #focus-veil {
  background: rgba(220,228,240,0.28);
}

/* dust canvas */
#dust-canvas {
  position: fixed; inset: 0;
  width: 100%; height: 100%;
  pointer-events: none; z-index: 1;
  mix-blend-mode: screen;
  transition: filter 0.35s ease, opacity 0.35s ease;
}
/* V5: focus mode blurs peripheral elements */
.focus-active #dust-canvas {
  filter: blur(2px);
  opacity: 0.45;
}

/* ── SIDE STRIPS ── */
.side-strip {
  position: fixed; top: 50%;
  transform: translateY(-50%);
  writing-mode: vertical-lr;
  font-size: 8px; font-weight: 700;
  letter-spacing: 3px; color: var(--blue);
  opacity: 0.14; pointer-events: none; z-index: 0;
  text-transform: uppercase;
  font-family: "JetBrains Mono", "Courier New", monospace;
  line-height: 1;
}
.side-strip-l { left: 6px; }
.side-strip-r { right: 6px; transform: translateY(-50%) rotate(180deg); }

/* ── V5: Perspective wrapper with rubber-band support ── */
#perspective-wrap {
  perspective: 1100px;
  perspective-origin: 50% 40%;
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative; z-index: 10;
  /* V5: rubber-band elastic transform */
  transform: translateY(var(--rubber-ty));
  transition: transform 0s linear;
  will-change: transform;
}
#perspective-wrap.rubber-release {
  transition: transform 0.45s cubic-bezier(0.28, 1.5, 0.42, 1);
}

/* ═══════════════════════════════════════════════
   MAIN CONTAINER
═══════════════════════════════════════════════ */
.terminal {
  width: calc(100% - 24px);
  max-width: 440px;
  position: relative;
  background: var(--glass);
  backdrop-filter: blur(28px) saturate(140%);
  -webkit-backdrop-filter: blur(28px) saturate(140%);
  border-radius: 22px;
  border: 2px solid rgba(255,255,255,0.98);
  outline: 1.5px solid rgba(255,170,178,0.28);
  outline-offset: 3px;
  box-shadow:
    0 16px 48px rgba(255,130,148,0.15),
    0 4px 16px rgba(125,227,248,0.12),
    0 1px 3px rgba(0,0,0,0.04);
  transform-style: preserve-3d;
  will-change: box-shadow, transform, filter;
  overflow: hidden;
}

/* noise texture */
.terminal::before {
  content: ''; position: absolute; inset: 0; border-radius: 20px;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-size: 180px; opacity: var(--noise);
  pointer-events: none; z-index: 100; mix-blend-mode: overlay;
}

/* scanlines */
.terminal::after {
  content: ''; position: absolute; inset: 0; border-radius: 20px;
  background: repeating-linear-gradient(
    0deg,
    transparent 0px, transparent 3px,
    rgba(106,217,245,0.014) 3px, rgba(106,217,245,0.014) 4px
  );
  animation: scanMove var(--scan-speed, 40s) linear infinite;
  pointer-events: none; z-index: 99;
}
@keyframes scanMove { from { background-position: 0 0; } to { background-position: 0 200px; } }

.terminal.state-loading    { --scan-speed: 20s; }
.terminal.state-idle       { --scan-speed: 40s; }
.terminal.state-speaking   { --scan-speed: 12s; }
.terminal.state-processing { --scan-speed: 5s;  }
.terminal.state-standby    { --scan-speed: 65s; }

/* Low activity dimming */
.terminal[data-activity="low"] .weiyu-card,
.terminal[data-activity="low"] .player-card,
.terminal[data-activity="low"] .news-item {
  opacity: 0.92; transition: opacity 1.2s ease;
}
.terminal[data-activity="low"] .header-right { opacity: 0.85; transition: opacity 1.2s ease; }
.terminal[data-activity="normal"] .weiyu-card,
.terminal[data-activity="normal"] .player-card,
.terminal[data-activity="normal"] .news-item,
.terminal[data-activity="normal"] .header-right {
  opacity: 1; transition: opacity 0.3s ease;
}

/* V5: Focus mode — peripheral UI retreats */
.terminal.focus-active .tactic-widgets,
.terminal.focus-active .clock-row,
.terminal.focus-active .header,
.terminal.focus-active .footer-nav {
  opacity: 0.35;
  filter: blur(0.8px);
  transition: opacity 0.35s ease, filter 0.35s ease;
}
.terminal.focus-active .weiyu-wrap {
  opacity: 0.5;
  transition: opacity 0.35s ease;
}

/* ═══════════════════════════════════════════════
   STATE BADGE
═══════════════════════════════════════════════ */
.state-badge {
  position: absolute; top: 14px; right: 14px;
  font-family: "JetBrains Mono", monospace;
  font-size: 7.5px; font-weight: 700;
  letter-spacing: 2px; text-transform: uppercase;
  padding: 3px 9px; border-radius: 100px; z-index: 200;
  transition: background var(--t-mid), color var(--t-mid), opacity var(--t-mid);
}
.state-badge.idle       { background: rgba(125,227,248,0.18); color: var(--blue-deep); }
.state-badge.loading    { background: rgba(255,200,100,0.2);  color: #c87800; }
.state-badge.speaking   { background: rgba(255,170,178,0.25); color: var(--pink-dark); }
.state-badge.processing { background: rgba(96,212,200,0.2);   color: var(--teal); }
.state-badge.standby    { background: rgba(186,200,216,0.2);  color: var(--text-light); }
.state-badge.focus      { background: rgba(180,160,255,0.22); color: #7050d0; }

/* ═══════════════════════════════════════════════
   HEADER
═══════════════════════════════════════════════ */
.header {
  padding: 22px 20px 10px;
  display: flex; align-items: flex-start;
  justify-content: space-between;
  position: relative; z-index: 10;
  transition: opacity 0.35s ease, filter 0.35s ease;
}
.title-block h1 {
  margin: 0; font-size: 26px; font-weight: 800;
  font-style: italic; color: var(--text);
  letter-spacing: 0.5px;
  text-shadow: 2px 2px 0 rgba(255,255,255,0.95);
  line-height: 1.1;
}
.title-block .sub {
  font-family: "JetBrains Mono", monospace;
  font-size: 8.5px; font-weight: 700;
  letter-spacing: 2.5px; color: var(--pink-dark);
  text-transform: uppercase; margin-top: 5px; opacity: 0.85;
}
.header-right {
  display: flex; flex-direction: column;
  align-items: flex-end; gap: 6px;
  padding-right: 4px; transition: opacity var(--t-slow);
}
.date-pill {
  background: linear-gradient(135deg, rgba(255,255,255,0.97) 0%, rgba(255,238,240,0.9) 100%);
  padding: 5px 13px; border-radius: 100px;
  font-family: "JetBrains Mono", monospace;
  font-size: 11px; font-weight: 700; color: var(--pink-dark);
  border: 1.5px solid rgba(255,170,178,0.4);
  box-shadow: 0 2px 8px rgba(255,142,153,0.1);
  white-space: nowrap;
}
.signal-meter { display: flex; align-items: flex-end; gap: 2.5px; height: 14px; }
.signal-bar {
  width: 3px; background: var(--text-faint); border-radius: 2px;
  transition: background 0.12s ease, height 0.12s ease;
}
.signal-bar:nth-child(1) { height: 30%; }
.signal-bar:nth-child(2) { height: 55%; }
.signal-bar:nth-child(3) { height: 75%; }
.signal-bar:nth-child(4) { height: 90%; }
.signal-bar:nth-child(5) { height: 100%; }
.signal-bar.active           { background: var(--blue-deep); }
.signal-bar.processing-pulse { background: var(--teal); transition: background 0.08s, height 0.08s; }

/* ═══════════════════════════════════════════════
   CLOCK ROW
═══════════════════════════════════════════════ */
.clock-row {
  display: flex; align-items: center; gap: 6px;
  padding: 0 18px 10px;
  position: relative; z-index: 10;
  transition: opacity 0.35s ease, filter 0.35s ease;
}
.clock-time {
  font-family: "JetBrains Mono", monospace;
  font-size: 11px; font-weight: 700;
  color: var(--text-light); letter-spacing: 1.5px;
}
.clock-dot {
  width: 5px; height: 5px; border-radius: 50%;
  background: var(--teal); opacity: 0.7;
  animation: pulse-dot 2s ease-in-out infinite;
}
@keyframes pulse-dot {
  0%, 100% { opacity: 0.7; transform: scale(1); }
  50%       { opacity: 1;   transform: scale(1.2); }
}
.clock-sep {
  flex: 1; height: 1px;
  background: linear-gradient(90deg, rgba(186,200,216,0.3) 0%, transparent 100%);
}
.online-badge {
  font-family: "JetBrains Mono", monospace;
  font-size: 7.5px; font-weight: 700;
  letter-spacing: 1.5px; text-transform: uppercase;
  color: var(--teal); background: rgba(96,212,200,0.1);
  padding: 2px 8px; border-radius: 100px;
}

/* ═══════════════════════════════════════════════
   DISTRIBUTED TACTIC WIDGETS
═══════════════════════════════════════════════ */
.tactic-widgets {
  padding: 0px 18px 10px;
  display: flex; gap: 8px;
  position: relative; z-index: 10;
  align-items: stretch;
  transition: opacity 0.35s ease, filter 0.35s ease;
}
.widget {
  flex: 1;
  background: rgba(255,255,255,0.5);
  border: 1px solid rgba(186,200,216,0.32);
  border-radius: 10px; padding: 7px 9px;
  overflow: hidden; position: relative; min-width: 0;
}
.widget::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(125,227,248,0.4), transparent);
}
.widget-label {
  font-family: "JetBrains Mono", monospace;
  font-size: 6px; font-weight: 700;
  letter-spacing: 2px; color: var(--text-faint);
  text-transform: uppercase; margin-bottom: 4px;
}

/* Waveform widget */
.waveform-canvas { display: block; width: 100%; height: 26px; }

/* focus mode blurs waveform */
.focus-active .waveform-canvas {
  filter: blur(1.5px);
  transition: filter 0.35s ease;
}

/* Code-stream widget */
.codestream-widget { flex: 1.4; }
.codestream-scroll {
  font-family: "JetBrains Mono", monospace;
  font-size: 5.5px; color: #5ab0e8;
  opacity: 0.75; line-height: 1.45;
  height: 26px; overflow: hidden; position: relative;
}
.codestream-inner {
  position: absolute; top: 0; left: 0; right: 0;
  animation: code-scroll 8s linear infinite;
}
@keyframes code-scroll {
  0%   { transform: translateY(0); }
  100% { transform: translateY(-50%); }
}

/* Radar widget */
.radar-widget { flex: 0 0 auto; width: 58px; }
.radar-wrap {
  display: flex; align-items: center; justify-content: center;
  height: 26px;
}
.radar-svg { width: 30px; height: 30px; overflow: visible; }
.radar-sweep {
  transform-origin: 50% 50%;
  animation: radar-spin 3.8s linear infinite;
}
@keyframes radar-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
.radar-blip { animation: blip-fade 3.8s linear infinite; }
@keyframes blip-fade {
  0%  { opacity: 0; } 5%  { opacity: 0.9; }
  20% { opacity: 0; } 100%{ opacity: 0; }
}

/* ═══════════════════════════════════════════════
   WEIYU CARD  (V5: tag resonance tint overlay)
═══════════════════════════════════════════════ */
.weiyu-wrap {
  padding: 4px 18px 12px;
  position: relative; z-index: 10;
  transition: opacity 0.35s ease;
}
.weiyu-card {
  background: var(--glass-inner);
  border-left: 3.5px solid var(--pink);
  border-radius: 4px 14px 14px 4px;
  padding: 14px 15px 13px; position: relative;
  box-shadow: 0 2px 12px rgba(255,170,178,0.1), 0 1px 4px rgba(125,227,248,0.05);
  transition: box-shadow var(--t-mid), border-color var(--t-mid), opacity var(--t-slow);
  min-height: 58px; overflow: hidden;
}
/* V5: resonance tint layer — extremely subtle */
.weiyu-card::before {
  content: '';
  position: absolute; inset: 0; border-radius: 0 12px 12px 0;
  background: hsla(var(--resonance-h), var(--resonance-s), var(--resonance-l), var(--resonance-alpha));
  pointer-events: none; z-index: 0;
  transition: background 0.4s ease;
}
.weiyu-card > * { position: relative; z-index: 1; }
.weiyu-card.speaking  { border-color: var(--pink-dark); box-shadow: 0 2px 22px rgba(255,142,153,0.22), 0 1px 8px rgba(125,227,248,0.1); }
.weiyu-card.idle-nudge{ box-shadow: 0 2px 24px rgba(255,170,178,0.3), 0 1px 10px rgba(125,227,248,0.15); }
.weiyu-label {
  position: absolute; top: -9px; left: 10px;
  background: var(--pink); color: white;
  font-size: 8px; padding: 2px 9px; border-radius: 4px;
  font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
  font-family: "JetBrains Mono", monospace;
  transition: background var(--t-mid), box-shadow var(--t-mid);
}
.weiyu-label.speaking  { background: var(--pink-dark); box-shadow: 0 0 10px rgba(255,142,153,0.45); }
.weiyu-label.idle-badge{ box-shadow: 0 0 10px rgba(255,170,178,0.6); }
.weiyu-text { font-size: 13px; line-height: 1.65; color: var(--text); margin: 0; min-height: 24px; }
.weiyu-cursor {
  display: inline-block; width: 1.5px; height: 14px;
  background: var(--pink-dark); margin-left: 1px;
  vertical-align: middle; animation: blink 1.1s steps(1) infinite;
}
@keyframes blink { 50% { opacity: 0; } }

/* ═══════════════════════════════════════════════
   VOICE PLAYER
═══════════════════════════════════════════════ */
.player-section {
  padding: 4px 18px 14px;
  position: relative; z-index: 10;
}
.player-card {
  background: linear-gradient(135deg, rgba(255,238,240,0.75) 0%, rgba(235,246,255,0.75) 100%);
  border: 1.5px solid rgba(255,200,210,0.45);
  border-radius: 16px; padding: 14px 16px;
  position: relative; overflow: hidden;
  box-shadow: 0 2px 12px rgba(255,170,178,0.08);
  transition: opacity var(--t-slow);
}
.player-card::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, rgba(125,227,248,0.05) 100%);
  pointer-events: none;
}
.player-row { display: flex; align-items: center; gap: 14px; }
.voice-core-wrap {
  position: relative; flex-shrink: 0;
  width: 52px; height: 52px;
  display: flex; align-items: center; justify-content: center;
}
.core-halo {
  position: absolute; border-radius: 50%;
  border: 1.5px solid rgba(255,170,178,0.3);
  transition: opacity var(--t-mid), transform var(--t-mid);
}
.halo-1 { width: 52px; height: 52px; }
.halo-2 { width: 64px; height: 64px; border-color: rgba(125,227,248,0.2); }
.halo-3 { width: 76px; height: 76px; border-color: rgba(255,170,178,0.12); }
.speaking .halo-1 { animation: halo-pulse 1.4s ease-out infinite; }
.speaking .halo-2 { animation: halo-pulse 1.4s ease-out infinite 0.3s; }
.speaking .halo-3 { animation: halo-pulse 1.4s ease-out infinite 0.6s; }
.processing .halo-1 { animation: halo-scan 1.2s ease-in-out infinite; }
.processing .halo-2 { animation: halo-scan 1.2s ease-in-out infinite 0.2s; }
@keyframes halo-pulse {
  0%   { transform: scale(1);    opacity: 0.6; }
  60%  { transform: scale(1.25); opacity: 0.15; }
  100% { transform: scale(1.4);  opacity: 0; }
}
@keyframes halo-scan {
  0%, 100% { border-color: rgba(125,227,248,0.25); }
  50%       { border-color: rgba(96,212,200,0.55); }
}
.voice-core {
  width: 44px; height: 44px; border-radius: 50%;
  background: linear-gradient(135deg, var(--pink-light) 0%, rgba(220,244,255,0.9) 100%);
  border: 2px solid rgba(255,255,255,0.9);
  box-shadow: 0 0 0 2px rgba(255,170,178,0.2), 0 4px 12px rgba(255,142,153,0.18), inset 0 1px 2px rgba(255,255,255,0.9);
  display: flex; align-items: center; justify-content: center;
  position: relative; z-index: 2;
  transition: box-shadow var(--t-mid), background var(--t-mid);
  cursor: pointer; overflow: hidden;
}
.voice-core.speaking {
  background: linear-gradient(135deg, rgba(255,200,210,0.95) 0%, rgba(200,240,255,0.9) 100%);
  box-shadow: 0 0 0 3px rgba(255,170,178,0.35), 0 0 20px rgba(255,142,153,0.3), 0 4px 14px rgba(255,142,153,0.2), inset 0 1px 2px rgba(255,255,255,0.9);
}
.voice-core.processing {
  box-shadow: 0 0 0 2px rgba(96,212,200,0.35), 0 0 16px rgba(96,212,200,0.25), 0 4px 12px rgba(125,227,248,0.2), inset 0 1px 2px rgba(255,255,255,0.9);
}
.voice-core.idle-pulse-anim { animation: idle-core-pulse 0.9s ease-out; }
@keyframes idle-core-pulse {
  0%   { box-shadow: 0 0 0 2px rgba(255,170,178,0.2), 0 4px 12px rgba(255,142,153,0.18), inset 0 1px 2px rgba(255,255,255,0.9); }
  40%  { box-shadow: 0 0 0 6px rgba(255,170,178,0.22), 0 0 24px rgba(255,142,153,0.32), inset 0 1px 2px rgba(255,255,255,0.9); }
  100% { box-shadow: 0 0 0 2px rgba(255,170,178,0.2), 0 4px 12px rgba(255,142,153,0.18), inset 0 1px 2px rgba(255,255,255,0.9); }
}
.play-icon  { width: 18px; height: 18px; fill: var(--pink-dark); transition: fill var(--t-fast); }
.pause-icon { width: 18px; height: 18px; fill: var(--pink-dark); display: none; }
.player-meta { flex: 1; min-width: 0; }
.player-title { font-size: 13px; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
.player-status {
  font-family: "JetBrains Mono", monospace;
  font-size: 9px; font-weight: 700;
  letter-spacing: 1.8px; text-transform: uppercase;
  color: var(--text-light); transition: color var(--t-mid);
}
.player-status.speaking   { color: var(--pink-dark); }
.player-status.processing { color: var(--teal); }
.progress-track {
  margin-top: 10px; height: 3px;
  background: rgba(186,200,216,0.35);
  border-radius: 100px; overflow: hidden; position: relative;
}
.progress-fill {
  height: 100%; width: 0%;
  background: linear-gradient(90deg, var(--pink) 0%, var(--blue) 100%);
  border-radius: 100px; transition: width 0.5s linear; position: relative;
}
.progress-fill::after {
  content: ''; position: absolute; right: -1px; top: 50%; transform: translateY(-50%);
  width: 5px; height: 5px; background: var(--pink-dark); border-radius: 50%;
  box-shadow: 0 0 4px rgba(255,142,153,0.6); opacity: 0; transition: opacity var(--t-fast);
}
.progress-fill.active::after { opacity: 1; }
.time-row {
  display: flex; justify-content: space-between; margin-top: 5px;
  font-family: "JetBrains Mono", monospace;
  font-size: 9px; color: var(--text-faint);
}

/* ═══════════════════════════════════════════════
   TACTICAL LINK PANEL
═══════════════════════════════════════════════ */
.tactical-link-panel {
  margin: 0 18px 14px;
  background: linear-gradient(135deg, rgba(235,248,255,0.82) 0%, rgba(228,255,250,0.72) 100%);
  border: 1.5px solid rgba(96,212,200,0.28);
  border-radius: 14px; padding: 11px 14px;
  position: relative; z-index: 10; display: none;
}
.tlp-header { display: flex; align-items: center; gap: 7px; margin-bottom: 9px; }
.tlp-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--teal); animation: pulse-dot 2s ease-in-out infinite; }
.tlp-title { font-family: "JetBrains Mono", monospace; font-size: 7.5px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--teal); flex: 1; }
.tlp-ver { font-family: "JetBrains Mono", monospace; font-size: 7px; color: var(--text-faint); letter-spacing: 1px; }
.tlp-row { display: flex; justify-content: space-between; align-items: center; padding: 3.5px 0; font-family: "JetBrains Mono", monospace; font-size: 9px; color: var(--text-light); border-bottom: 1px solid rgba(186,200,216,0.14); }
.tlp-row:last-child { border-bottom: none; }
.tlp-key { letter-spacing: 0.5px; }
.tlp-val { font-weight: 700; color: var(--text); letter-spacing: 0.5px; }
.tlp-val.green { color: var(--teal); }
.tlp-val.blink { animation: blink 1.8s steps(1) infinite; }

/* ═══════════════════════════════════════════════
   SECTION DIVIDER
═══════════════════════════════════════════════ */
.section-head {
  padding: 4px 18px 8px;
  display: flex; align-items: center; gap: 10px;
  position: relative; z-index: 10;
}
.section-label {
  font-family: "JetBrains Mono", monospace;
  font-size: 9px; font-weight: 700;
  letter-spacing: 2.5px; text-transform: uppercase;
  color: var(--text-light); white-space: nowrap;
}
.section-line { flex: 1; height: 1px; background: linear-gradient(90deg, rgba(186,200,216,0.4) 0%, transparent 100%); }
.section-count {
  font-family: "JetBrains Mono", monospace;
  font-size: 8.5px; font-weight: 700;
  color: var(--pink); background: rgba(255,170,178,0.12);
  padding: 2px 7px; border-radius: 100px;
}

/* ═══════════════════════════════════════════════
   NEWS LIST
═══════════════════════════════════════════════ */
.news-list {
  list-style: none; margin: 0;
  padding: 0 18px 20px;
  position: relative; z-index: 10;
  display: flex; flex-direction: column; gap: 7px;
}
.news-item {
  background: var(--glass-inner);
  border: 1.5px solid rgba(255,255,255,0.9);
  border-radius: 12px; padding: 11px 13px;
  position: relative; overflow: hidden;
  transition:
    transform var(--t-fast) cubic-bezier(0.34,1.56,0.64,1),
    box-shadow var(--t-mid),
    border-color var(--t-mid),
    opacity var(--t-slow),
    filter var(--t-mid);
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  box-shadow: 0 1px 6px rgba(0,0,0,0.03);
  will-change: transform, box-shadow;
}

/* scan sweep overlay */
.news-item::before {
  content: ''; position: absolute; left: -100%; top: 0;
  width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent 0%, rgba(125,227,248,0.12) 40%, rgba(96,212,200,0.1) 60%, transparent 100%);
  pointer-events: none; opacity: 0; transition: opacity var(--t-mid);
}
.news-item::after {
  content: ''; position: absolute; left: 0; top: 0;
  width: 3px; height: 100%;
  background: transparent; border-radius: 2px 0 0 2px;
  transition: background var(--t-mid);
}
.news-item.processing-scan::before { animation: scan-sweep 1.4s ease-in-out; }
.news-item.processing-scan::after  { background: var(--teal); }
.news-item.processing-scan { border-color: rgba(96,212,200,0.3); box-shadow: 0 1px 12px rgba(96,212,200,0.12); }
@keyframes scan-sweep { 0% { left: -100%; opacity: 1; } 100% { left: 100%; opacity: 0.3; } }

/* press states */
.news-item:active, .news-item.pressed {
  transform: scale(0.975); box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}
.news-item.released {
  transform: scale(1.008); transition: transform 0.2s cubic-bezier(0.34,1.56,0.64,1);
}

/* glitch on news item */
.news-item.glitch-item {
  animation: item-glitch 0.17s ease forwards;
  pointer-events: none;
}
@keyframes item-glitch {
  0%   { transform: translateX(0); filter: none; }
  18%  { transform: translateX(-4px) scaleX(0.993); filter: hue-rotate(30deg) brightness(1.09); }
  36%  { transform: translateX(3px)  scaleX(1.008); filter: hue-rotate(-25deg); }
  55%  { transform: translateX(-2px); filter: hue-rotate(12deg) saturate(1.3); }
  72%  { transform: translateX(1px); filter: none; }
  100% { transform: translateX(0);   filter: none; }
}

/* V5: Magnetic focus — center-zone enhancement */
.news-item.magnetic {
  border-color: rgba(255,170,178,0.4);
  box-shadow:
    0 2px 14px rgba(255,142,153,0.13),
    0 0 0 1px rgba(255,200,215,0.25),
    inset 0 0 8px rgba(255,238,240,0.3);
  transition:
    transform 0.28s cubic-bezier(0.34,1.56,0.64,1),
    box-shadow 0.28s ease,
    border-color 0.28s ease,
    opacity var(--t-slow),
    filter var(--t-mid);
}
/* Subtle left backlight on magnetic items */
.news-item.magnetic::after {
  background: linear-gradient(180deg, rgba(255,170,178,0.55), rgba(125,227,248,0.35));
}

/* V5: Focus mode — non-focused items fade and blur slightly */
.focus-active .news-item:not(.focus-target) {
  opacity: 0.38;
  filter: blur(0.6px);
  transform: scale(0.99);
}
/* V5: Focus target — prominent ring */
.news-item.focus-target {
  border-color: rgba(255,142,153,0.6);
  box-shadow:
    0 0 0 2px rgba(255,170,178,0.22),
    0 4px 24px rgba(255,130,148,0.22),
    0 1px 8px rgba(125,227,248,0.15);
  transform: scale(1.012);
  z-index: 20;
}
/* Focus target "deep analysis" overlay */
.news-item.focus-target::before {
  content: '';
  position: absolute; left: 0; top: 0; right: 0; bottom: 0;
  background: linear-gradient(135deg, rgba(255,238,240,0.18) 0%, rgba(220,244,255,0.08) 100%);
  opacity: 1; pointer-events: none;
}

/* expanded intel summary */
.news-main { display: flex; gap: 11px; align-items: flex-start; }
.news-summary {
  max-height: 0; overflow: hidden; opacity: 0;
  transition: max-height 0.4s cubic-bezier(0.4,0,0.2,1), opacity 0.3s ease 0.06s;
}
.news-item.expanded .news-summary { max-height: 120px; opacity: 1; }
.summary-inner {
  padding-top: 9px; margin-top: 7px;
  border-top: 1px dashed rgba(125,227,248,0.38);
}
.summary-label {
  font-family: "JetBrains Mono", monospace;
  font-size: 7px; font-weight: 700;
  letter-spacing: 2px; text-transform: uppercase;
  color: var(--teal); margin-bottom: 5px;
}
.summary-text { font-size: 11.5px; line-height: 1.58; color: var(--text-light); }
.summary-classify {
  display: inline-block; margin-bottom: 4px;
  font-family: "JetBrains Mono", monospace;
  font-size: 7px; font-weight: 700;
  letter-spacing: 1.5px; text-transform: uppercase;
  background: rgba(255,170,178,0.12); color: var(--pink-dark);
  padding: 1px 6px; border-radius: 4px;
}

.news-index {
  font-family: "JetBrains Mono", monospace;
  font-size: 10px; font-weight: 700; color: var(--pink);
  min-width: 20px; padding-top: 1px; line-height: 1.4; flex-shrink: 0;
}
.news-content { font-size: 12.5px; line-height: 1.6; color: var(--text); flex: 1; }
.news-tag {
  flex-shrink: 0; font-family: "JetBrains Mono", monospace;
  font-size: 7.5px; font-weight: 700;
  letter-spacing: 1px; padding: 2px 7px;
  border-radius: 100px; text-transform: uppercase; margin-top: 1px;
}
.tag-tech    { background: rgba(125,227,248,0.18); color: var(--blue-deep); }
.tag-world   { background: rgba(96,212,200,0.15);  color: #2ba89e; }
.tag-finance { background: rgba(255,200,100,0.18); color: #c87800; }
.tag-sci     { background: rgba(180,160,255,0.18); color: #7050d0; }
.tag-health  { background: rgba(255,170,178,0.2);  color: var(--pink-dark); }

/* ═══════════════════════════════════════════════
   V5: LONG-PRESS FOCUS INDICATOR
═══════════════════════════════════════════════ */
.focus-hint {
  position: absolute; top: 6px; right: 8px;
  font-family: "JetBrains Mono", monospace;
  font-size: 6.5px; font-weight: 700;
  letter-spacing: 1.5px; text-transform: uppercase;
  color: #7050d0; background: rgba(180,160,255,0.18);
  padding: 2px 6px; border-radius: 4px;
  opacity: 0; transform: translateY(-2px);
  transition: opacity 0.2s ease, transform 0.2s ease;
  pointer-events: none; z-index: 5;
}
.news-item.focus-target .focus-hint {
  opacity: 1; transform: translateY(0);
}

/* ═══════════════════════════════════════════════
   PAGINATION
═══════════════════════════════════════════════ */
.pagination {
  padding: 0 18px 16px;
  display: flex; align-items: center; justify-content: center; gap: 10px;
  position: relative; z-index: 10;
}
.page-btn {
  width: 34px; height: 34px; border-radius: 50%;
  border: 1.5px solid rgba(255,170,178,0.35);
  background: var(--glass-inner);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; position: relative; overflow: hidden;
  transition: transform var(--t-fast) cubic-bezier(0.34,1.56,0.64,1), box-shadow var(--t-fast), border-color var(--t-mid), opacity var(--t-mid);
  -webkit-tap-highlight-color: transparent; flex-shrink: 0;
}
.page-btn svg { width: 14px; height: 14px; fill: var(--pink-dark); pointer-events: none; }
.page-btn:active, .page-btn.pressed { transform: scale(0.88); box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
.page-btn.released { transform: scale(1.1); transition: transform 0.22s cubic-bezier(0.34,1.56,0.64,1); }
.page-btn.disabled { opacity: 0.28; pointer-events: none; }
.page-dots { display: flex; align-items: center; gap: 6px; flex: 1; justify-content: center; }
.page-dot {
  height: 6px; width: 6px; border-radius: 100px;
  background: rgba(186,200,216,0.5);
  transition: background var(--t-mid), width var(--t-mid), box-shadow var(--t-mid);
}
.page-dot.active { background: var(--pink); width: 18px; box-shadow: 0 0 6px rgba(255,142,153,0.4); }
.page-label {
  font-family: "JetBrains Mono", monospace;
  font-size: 9px; font-weight: 700;
  letter-spacing: 1.5px; color: var(--text-faint);
  white-space: nowrap; min-width: 44px; text-align: center;
}
.news-list.exit-prev  { animation: exitPrev  0.2s cubic-bezier(0.4,0,1,1) forwards; }
.news-list.exit-next  { animation: exitNext  0.2s cubic-bezier(0.4,0,1,1) forwards; }
.news-list.enter-prev { animation: enterPrev 0.28s cubic-bezier(0,0,0.2,1) forwards; }
.news-list.enter-next { animation: enterNext 0.28s cubic-bezier(0,0,0.2,1) forwards; }
@keyframes exitNext  { to { opacity: 0; transform: translateX(-22px); } }
@keyframes exitPrev  { to { opacity: 0; transform: translateX(22px); } }
@keyframes enterNext { from { opacity: 0; transform: translateX(22px); } to { opacity: 1; transform: none; } }
@keyframes enterPrev { from { opacity: 0; transform: translateX(-22px); } to { opacity: 1; transform: none; } }

/* ═══════════════════════════════════════════════
   FOOTER NAV
═══════════════════════════════════════════════ */
.footer-nav {
  padding: 10px 18px 14px;
  display: flex; justify-content: space-between; align-items: center;
  border-top: 1px solid rgba(186,200,216,0.2);
  position: relative; z-index: 10;
  transition: opacity 0.35s ease, filter 0.35s ease;
}
.nav-btn {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  cursor: default; pointer-events: none;
  padding: 4px 8px; border-radius: 10px;
  -webkit-tap-highlight-color: transparent;
}
.nav-icon { width: 22px; height: 22px; fill: var(--text-faint); transition: fill var(--t-fast); }
.nav-btn.active .nav-icon  { fill: var(--pink-dark); }
.nav-label {
  font-family: "JetBrains Mono", monospace;
  font-size: 7.5px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase;
  color: var(--text-faint); transition: color var(--t-fast);
}
.nav-btn.active .nav-label { color: var(--pink-dark); }
.nav-btn.active { position: relative; }
.nav-btn.active::after {
  content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 4px; height: 4px; background: var(--pink); border-radius: 50%;
}

/* ═══════════════════════════════════════════════
   LOADING SCREEN
═══════════════════════════════════════════════ */
.loading-screen {
  position: absolute; inset: 0; border-radius: 22px;
  background: rgba(255,255,255,0.96);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 500; gap: 16px; transition: opacity 0.5s ease;
}
.loading-screen.done { opacity: 0; pointer-events: none; }
.load-ring-wrap { position: relative; width: 54px; height: 54px; }
.load-ring {
  position: absolute; inset: 0; border-radius: 50%;
  border: 2.5px solid transparent; border-top-color: var(--pink);
  animation: spin 1s linear infinite;
}
.load-ring-2 { inset: 6px; border-top-color: var(--blue); animation: spin 1.4s linear infinite reverse; }
@keyframes spin { to { transform: rotate(360deg); } }
.load-center { position: absolute; inset: 14px; background: linear-gradient(135deg, var(--pink-light) 0%, rgba(220,244,255,0.9) 100%); border-radius: 50%; }
.load-text { font-family: "JetBrains Mono", monospace; font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--text-light); }
.load-dots::after { content: ''; animation: dots 1.2s steps(4, end) infinite; }
@keyframes dots { 0%{ content:''; } 25%{ content:'.'; } 50%{ content:'..'; } 75%{ content:'...'; } }

/* ═══════════════════════════════════════════════
   GLITCH
═══════════════════════════════════════════════ */
.glitch-active {
  animation: glitch 0.14s cubic-bezier(0.25,0.46,0.45,0.94);
  filter: hue-rotate(12deg) contrast(1.05) !important;
}
@keyframes glitch {
  0%   { clip-path: inset(20% 0 78% 0); transform: translate(-1px, 0.5px) scale(var(--breath-scale)); }
  25%  { clip-path: inset(60% 0 14% 0); transform: translate(1px, -0.5px) scale(var(--breath-scale)); }
  50%  { clip-path: inset(40% 0 50% 0); transform: translate(-1px, 1px) scale(var(--breath-scale)); }
  75%  { clip-path: inset(75% 0 10% 0); transform: translate(0.5px,-0.5px) scale(var(--breath-scale)); }
  100% { clip-path: inset(0 0 0 0);     transform: translate(0) scale(var(--breath-scale)); }
}

/* ═══════════════════════════════════════════════
   REVEAL
═══════════════════════════════════════════════ */
.reveal-item { opacity: 0; transform: translateY(8px); transition: opacity 0.4s ease, transform 0.4s ease; }
.reveal-item.visible { opacity: 1; transform: translateY(0); }

/* ═══════════════════════════════════════════════
   V5: DATA PIXEL BURST (button click effect)
   Replaces plain ripple with micro pixel scatter
═══════════════════════════════════════════════ */
.pixel-burst {
  position: absolute;
  width: 3px; height: 3px;
  border-radius: 1px;
  pointer-events: none;
  will-change: transform, opacity;
  animation: pixel-scatter var(--px-dur, 0.32s) var(--px-ease, cubic-bezier(0.22,1,0.36,1)) forwards;
}
@keyframes pixel-scatter {
  0%   { transform: translate(0, 0) scale(1);                                  opacity: 0.85; }
  60%  { transform: translate(var(--px-tx), var(--px-ty)) scale(0.6);         opacity: 0.5; }
  100% { transform: translate(var(--px-tx2), var(--px-ty2)) scale(0);         opacity: 0; }
}

/* ═══════════════════════════════════════════════
   V5: RUBBER-BAND indicator
═══════════════════════════════════════════════ */
.rubber-indicator {
  position: absolute; left: 0; right: 0;
  height: 2px; border-radius: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,170,178,0.5), transparent);
  opacity: 0; pointer-events: none; z-index: 200;
  transition: opacity 0.2s ease;
}
.rubber-indicator.top    { top: 0; }
.rubber-indicator.bottom { bottom: 0; }
.rubber-indicator.visible { opacity: 1; }

/* old ripple kept for fallback */
.ripple {
  position: absolute; border-radius: 50%;
  background: rgba(255,170,178,0.15);
  transform: scale(0);
  animation: ripple-anim 0.3s ease-out forwards;
  pointer-events: none;
}
@keyframes ripple-anim { to { transform: scale(2.5); opacity: 0; } }
</style>
</head>
<body>

<div id="bg-breath-overlay"></div>
<canvas id="dust-canvas"></canvas>
<div id="focus-veil"></div>

<div class="side-strip side-strip-l">SCHALE INTEL · TACTICAL BRIEF · KIVOTOS</div>
<div class="side-strip side-strip-r">AUTHORIZED · SENSEI ONLY · CONFIDENTIAL</div>

<div id="perspective-wrap">

<div class="terminal state-loading" id="terminal" data-activity="normal">

  <div class="rubber-indicator top"    id="rubber-top"></div>
  <div class="rubber-indicator bottom" id="rubber-bot"></div>

  <div class="loading-screen" id="loading-screen">
    <div class="load-ring-wrap">
      <div class="load-ring"></div>
      <div class="load-ring load-ring-2"></div>
      <div class="load-center"></div>
    </div>
    <div class="load-text">INTEL DECODE<span class="load-dots"></span></div>
  </div>

  <div class="state-badge idle" id="state-badge">IDLE</div>

  <div class="header reveal-item">
    <div class="title-block">
      <h1>早報</h1>
      <div class="sub">Schale Intelligence · Daily Brief</div>
    </div>
    <div class="header-right">
      <div class="date-pill" id="date-display">Loading…</div>
      <div class="signal-meter" id="signal-meter">
        <div class="signal-bar"></div>
        <div class="signal-bar active"></div>
        <div class="signal-bar active"></div>
        <div class="signal-bar active"></div>
        <div class="signal-bar active"></div>
      </div>
    </div>
  </div>

  <div class="clock-row reveal-item" style="transition-delay:0.05s">
    <div class="clock-time" id="clock-time">00:00</div>
    <div class="clock-dot"></div>
    <div class="clock-sep"></div>
    <div class="online-badge">ONLINE</div>
  </div>

  <div class="tactic-widgets reveal-item" style="transition-delay:0.08s">
    <div class="widget">
      <div class="widget-label">SYS.LOAD</div>
      <canvas class="waveform-canvas" id="waveform-canvas"></canvas>
    </div>
    <div class="widget codestream-widget">
      <div class="widget-label">DECODE.STREAM</div>
      <div class="codestream-scroll" id="codestream-scroll">
        <div class="codestream-inner" id="codestream-inner"></div>
      </div>
    </div>
    <div class="widget radar-widget">
      <div class="widget-label">SCAN</div>
      <div class="radar-wrap">
        <svg class="radar-svg" viewBox="0 0 30 30">
          <circle cx="15" cy="15" r="12" fill="none" stroke="rgba(125,227,248,0.2)" stroke-width="0.7"/>
          <circle cx="15" cy="15" r="8"  fill="none" stroke="rgba(125,227,248,0.15)" stroke-width="0.5"/>
          <circle cx="15" cy="15" r="4"  fill="none" stroke="rgba(125,227,248,0.12)" stroke-width="0.4"/>
          <line x1="3" y1="15" x2="27" y2="15" stroke="rgba(96,212,200,0.2)" stroke-width="0.5"/>
          <line x1="15" y1="3" x2="15"  y2="27" stroke="rgba(96,212,200,0.2)" stroke-width="0.5"/>
          <g class="radar-sweep">
            <line x1="15" y1="15" x2="15" y2="3.5" stroke="rgba(96,212,200,0.75)" stroke-width="0.9" stroke-linecap="round"/>
            <circle cx="15" cy="4.2" r="0.9" fill="rgba(255,170,178,0.9)" class="radar-blip"/>
          </g>
          <circle cx="15" cy="15" r="1.1" fill="rgba(96,212,200,0.7)"/>
        </svg>
      </div>
    </div>
  </div>

  <div class="weiyu-wrap reveal-item" style="transition-delay:0.1s">
    <div class="weiyu-card" id="weiyu-card">
      <div class="weiyu-label" id="weiyu-label">MomoTalk · AI</div>
      <p class="weiyu-text" id="weiyu-text"><span class="weiyu-cursor"></span></p>
    </div>
  </div>

  <div class="player-section reveal-item" style="transition-delay:0.15s" id="audio-wrapper">
    <div class="player-card">
      <div class="player-row">
        <div class="voice-core-wrap">
          <div class="halo-3 core-halo"></div>
          <div class="halo-2 core-halo"></div>
          <div class="halo-1 core-halo"></div>
          <div class="voice-core" id="voice-core" role="button" aria-label="Play / Pause">
            <svg class="play-icon" id="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            <svg class="pause-icon" id="pause-icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
          </div>
        </div>
        <div class="player-meta">
          <div class="player-title">Schale 战术早报 · 情报播报</div>
          <div class="player-status" id="player-status">READY</div>
          <div class="progress-track">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <div class="time-row">
            <span id="time-current">0:00</span>
            <span id="time-total">0:00</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tactical-link-panel reveal-item" id="tactical-link-panel" style="transition-delay:0.15s">
    <div class="tlp-header">
      <div class="tlp-dot"></div>
      <div class="tlp-title">KIVOTOS · LINK STATUS</div>
      <div class="tlp-ver">v5.0</div>
    </div>
    <div class="tlp-row"><span class="tlp-key">全境连接状态</span><span class="tlp-val green">● GREEN</span></div>
    <div class="tlp-row"><span class="tlp-key">战术节点</span><span class="tlp-val blink">7 / 7 ONLINE</span></div>
    <div class="tlp-row"><span class="tlp-key">感知架构</span><span class="tlp-val" style="color:#7050d0">ACTIVE</span></div>
    <div class="tlp-row"><span class="tlp-key">加密协议</span><span class="tlp-val">AES-SCHALE</span></div>
    <div class="tlp-row"><span class="tlp-key">最后同步</span><span class="tlp-val" id="tlp-sync-time">--:--</span></div>
  </div>

  <div class="section-head reveal-item" style="transition-delay:0.2s">
    <div class="section-label">Intelligence Report</div>
    <div class="section-line"></div>
    <div class="section-count" id="news-count">·/·</div>
  </div>

  <ul class="news-list reveal-item" id="news-list" style="transition-delay:0.25s"></ul>

  <div class="pagination reveal-item" id="pagination" style="transition-delay:0.28s">
    <button class="page-btn disabled" id="page-prev" aria-label="上一页">
      <svg viewBox="0 0 24 24"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6z"/></svg>
    </button>
    <div class="page-dots" id="page-dots"></div>
    <div class="page-label" id="page-label">1 / 1</div>
    <button class="page-btn disabled" id="page-next" aria-label="下一页">
      <svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
    </button>
  </div>

  <div class="footer-nav reveal-item" style="transition-delay:0.3s">
    <div class="nav-btn active">
      <svg class="nav-icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      <div class="nav-label">早報</div>
    </div>
    <div class="nav-btn">
      <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>
      <div class="nav-label">情報</div>
    </div>
    <div class="nav-btn">
      <svg class="nav-icon" viewBox="0 0 24 24"><path d="M20 6h-2.18c.07-.44.18-.88.18-1.36C18 2.09 15.91 0 13.36 0c-1.3 0-2.51.52-3.36 1.36L9 2.36 7.99 1.35C7.14.51 5.94 0 4.64 0 2.09 0 0 2.09 0 4.64c0 .48.1.92.18 1.36H0v2h20V6zm-7.82-4c.66 0 1.29.26 1.76.73l.73.73H10.34l.72-.72C11.53 2.26 12.16 2 12.18 2zM4 8v13h16V8H4zm8 9l-4-4h2.5v-4h3v4H16l-4 4z"/></svg>
      <div class="nav-label">歸檔</div>
    </div>
    <div class="nav-btn">
      <svg class="nav-icon" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94s-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.6-.22l-2.39.96a7.15 7.15 0 00-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.488.488 0 00-.6.22L2.74 8.87a.478.478 0 00.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32a.48.48 0 00-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
      <div class="nav-label">設定</div>
    </div>
  </div>

</div><!-- .terminal -->
</div><!-- #perspective-wrap -->

<audio id="audio-source" preload="metadata" crossorigin="anonymous"></audio>

<script>
/* ═══════════════════════════════════════════════════
   SCHALE INTELLIGENCE TERMINAL  v5
   "感知架构 (Perceptive Architecture)"

   New Systems (v5):
   ┌───────────────────────────────────────────────┐
   │  MagneticScroll  — center-zone magnetic focus │
   │  TagResonance    — tag-driven tint drift      │
   │  FocusMode       — long-press deep analysis   │
   │  RubberBand      — elastic scroll damping     │
   │  PixelBurst      — data-recombination click   │
   └───────────────────────────────────────────────┘

   Retained from v4:
   ┌───────────────────────────────────────────────┐
   │  ParticleEngine  BreathEngine  TiltEngine     │
   │  WidgetEngine    FSM  NeuralReflex            │
   │  LowActivity     SignalRhythm  Paginator      │
   │  DataShred       AudioSystem   ScanHighlight  │
   └───────────────────────────────────────────────┘
═══════════════════════════════════════════════════ */

const CONFIG = {
  api:           './data.json',
  cacheKey:      'schale_intel_v5',
  standbyDelay:  60000,
  lowActivityMs: 5000,
  idleNudgeMin:  40000,
  idleNudgeMax:  90000,
};

const DEMO = {
  date: new Date().toLocaleDateString('zh-CN', { month:'long', day:'numeric', weekday:'short' }),
  weiyu: '早上好，老师。今天的情报已就绪，请查阅。基沃托斯目前状态稳定，Schale 感知架构已全面启动。',
  audio: null,
  news: [
    { text: '全球 AI 研究机构联合发布新一代多模态基准测试，涵盖视觉推理与代码生成能力评估。', tag: 'tech' },
    { text: '国际能源署报告显示，2025年可再生能源装机容量首次超过化石燃料总量。', tag: 'world' },
    { text: '量子计算公司宣布实现 1000 量子比特稳定运行，商业应用窗口或提前至明年。', tag: 'sci' },
    { text: '亚太科技股集体回暖，半导体板块单日涨幅领跑，市场情绪转向乐观。', tag: 'finance' },
    { text: '新型纳米抗体药物临床三期数据公布，对多种耐药菌显示出显著抑制效果。', tag: 'health' },
    { text: '基沃托斯联合委员会就学院间协作框架达成初步共识，细节将于本周正式公布。', tag: 'world' },
  ]
};

const _tilt = { rx: 0, ry: 0 };

/* ═══════════════════════════════════════════════
   STATE MACHINE
═══════════════════════════════════════════════ */
const FSM = (() => {
  let _state = 'LOADING';
  const _listeners = [];
  const STATES = ['IDLE','LOADING','SPEAKING','PROCESSING','STANDBY'];
  const BREATH = {
    IDLE:       { hz: 1/7,    depth: 0.0024, shadowAmp: 0.65 },
    LOADING:    { hz: 0,      depth: 0,      shadowAmp: 0    },
    SPEAKING:   { hz: 1/5.5,  depth: 0.0030, shadowAmp: 1.0  },
    PROCESSING: { hz: 1/7,    depth: 0.0022, shadowAmp: 0.85 },
    STANDBY:    { hz: 1/14,   depth: 0.0012, shadowAmp: 0.30 },
  };
  return {
    get state()     { return _state; },
    get breathCfg() { return BREATH[_state]; },
    transition(next) {
      if (!STATES.includes(next) || next === _state) return;
      const prev = _state; _state = next;
      _listeners.forEach(fn => fn(next, prev));
    },
    on(fn) { _listeners.push(fn); }
  };
})();

/* ═══════════════════════════════════════════════
   BREATH ENGINE
═══════════════════════════════════════════════ */
const BreathEngine = (() => {
  let _phase = 0, _raf = null, _lastT = null;
  let _paused = false, _pausedRaw = 0.5;

  function getTerm() { return document.getElementById('terminal'); }

  function tick(t) {
    if (!_lastT) _lastT = t;
    const dt = Math.min((t - _lastT) / 1000, 0.05);
    _lastT = t;
    const { hz, depth, shadowAmp } = FSM.breathCfg;
    if (hz === 0) { _raf = requestAnimationFrame(tick); return; }
    _phase += hz * dt * Math.PI * 2;
    const raw = (Math.sin(_phase) + 1) / 2;
    const s   = _paused ? _pausedRaw : raw;
    const sc  = 1 + s * depth;
    const bg  = document.getElementById('bg-breath-overlay');
    const rx  = _tilt.rx, ry = _tilt.ry;
    const term = getTerm();
    if (!term) { _raf = requestAnimationFrame(tick); return; }
    term.style.transform = `perspective(1100px) rotateX(${rx}deg) rotateY(${ry}deg) scale(${sc})`;
    term.style.setProperty('--breath-scale', sc);
    const gAlpha = (0.08 + s * shadowAmp * 0.10).toFixed(3);
    const bAlpha = (0.05 + s * shadowAmp * 0.07).toFixed(3);
    term.style.boxShadow = [
      `0 16px ${44 + s * 16}px rgba(255,130,148,${gAlpha})`,
      `0 4px ${12 + s * 8}px rgba(125,227,248,${bAlpha})`,
      '0 1px 3px rgba(0,0,0,0.04)'
    ].join(',');
    if (bg) bg.style.opacity = (0.04 + s * 0.04).toFixed(3);
    _raf = requestAnimationFrame(tick);
  }

  return {
    start() { if (!_raf) { _lastT = null; _raf = requestAnimationFrame(tick); } },
    stop()  { if (_raf)  { cancelAnimationFrame(_raf); _raf = null; } },
    pauseFor(ms) {
      _paused = true; _pausedRaw = 0.5;
      setTimeout(() => { _paused = false; }, ms);
    }
  };
})();

/* ═══════════════════════════════════════════════
   TILT ENGINE
═══════════════════════════════════════════════ */
const TiltEngine = (() => {
  const MAX = 5;
  let tx = 0, ty = 0, raf = null;

  function tick() {
    const EAS = 0.06;
    _tilt.rx += (tx - _tilt.rx) * EAS;
    _tilt.ry += (ty - _tilt.ry) * EAS;
    raf = requestAnimationFrame(tick);
  }

  return {
    init() {
      if (window.DeviceOrientationEvent) {
        window.addEventListener('deviceorientation', e => {
          if (e.gamma === null) return;
          ty = Math.max(-MAX, Math.min(MAX, e.gamma * 0.18));
          tx = Math.max(-MAX, Math.min(MAX, (e.beta - 30) * 0.10));
        }, { passive: true });
      } else {
        window.addEventListener('mousemove', e => {
          const hw = window.innerWidth / 2, hh = window.innerHeight / 2;
          ty =  ((e.clientX - hw) / hw) * MAX;
          tx = -((e.clientY - hh) / hh) * MAX;
        }, { passive: true });
        window.addEventListener('mouseleave', () => { tx = 0; ty = 0; }, { passive: true });
      }
      raf = requestAnimationFrame(tick);
    }
  };
})();

/* ═══════════════════════════════════════════════
   PARTICLE ENGINE
═══════════════════════════════════════════════ */
const ParticleEngine = (() => {
  let canvas, ctx, particles = [];
  let scrollVY = 0, lastScrollY = 0;
  let raf = null;
  const COUNT = 55;

  function resize() {
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  function make() {
    return {
      x:    Math.random() * (canvas.width || window.innerWidth),
      y:    Math.random() * (canvas.height || window.innerHeight),
      vx:   (Math.random() - 0.5) * 0.28,
      vy:   -(0.12 + Math.random() * 0.22),
      r:    0.55 + Math.random() * 1.1,
      op:   0.03 + Math.random() * 0.07,
      life: Math.random(),
      dr:   0.0018 + Math.random() * 0.0012,
    };
  }
  function tick() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    scrollVY *= 0.90;
    for (let i = 0; i < particles.length; i++) {
      const p = particles[i];
      p.x += p.vx + Math.sin(p.life * 3.1) * 0.08;
      p.y += p.vy + scrollVY * 0.06;
      p.life -= p.dr;
      if (p.life <= 0 || p.y < -8 || p.x < -8 || p.x > canvas.width + 8) {
        particles[i] = make();
        particles[i].y = p.y < -8 ? canvas.height + 5 : particles[i].y;
        continue;
      }
      const alpha = p.op * Math.min(p.life * 3, 1);
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fillStyle = p.r > 1.3
        ? `rgba(255,200,215,${(alpha * 0.9).toFixed(3)})`
        : `rgba(190,225,255,${alpha.toFixed(3)})`;
      ctx.fill();
    }
    raf = requestAnimationFrame(tick);
  }
  return {
    init() {
      canvas = document.getElementById('dust-canvas');
      ctx    = canvas.getContext('2d');
      resize();
      window.addEventListener('resize', resize, { passive: true });
      window.addEventListener('scroll', () => {
        const dy = window.scrollY - lastScrollY;
        scrollVY = dy * 0.55;
        lastScrollY = window.scrollY;
      }, { passive: true });
      particles = Array.from({ length: COUNT }, make);
      raf = requestAnimationFrame(tick);
    }
  };
})();

/* ═══════════════════════════════════════════════
   WIDGET ENGINE
═══════════════════════════════════════════════ */
const WidgetEngine = (() => {
  let wCanvas, wCtx, wPhase = 0, wLoad = 0.55;
  const HEX_CHARS  = '0123456789ABCDEF';
  const CODE_WORDS = ['0xC4FF','AUTH','SYNC','0x3A1B','KIVOTOS','DECODE','0xFF80','SCH4LE','INTEL','0x7E2A'];

  function waveformTick() {
    if (!wCanvas) return;
    const W = wCanvas.width / (window.devicePixelRatio || 1);
    const H = wCanvas.height / (window.devicePixelRatio || 1);
    wCtx.clearRect(0, 0, wCanvas.width, wCanvas.height);
    wPhase += 0.04;
    wLoad  += (Math.random() - 0.495) * 0.012;
    wLoad   = Math.max(0.15, Math.min(0.9, wLoad));
    wCtx.save(); wCtx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);
    wCtx.beginPath(); wCtx.moveTo(0, H);
    for (let x = 0; x <= W; x++) {
      const t2 = x / W;
      const yf = 0.5 + Math.sin(t2*Math.PI*3.2+wPhase)*0.28 + Math.sin(t2*Math.PI*7.1-wPhase*1.4)*0.12 + Math.sin(t2*Math.PI*1.8+wPhase*0.6)*wLoad*0.35;
      wCtx.lineTo(x, H - yf * H * 0.85);
    }
    wCtx.lineTo(W, H); wCtx.closePath();
    const grad = wCtx.createLinearGradient(0,0,0,H);
    grad.addColorStop(0,'rgba(125,227,248,0.55)');
    grad.addColorStop(0.5,'rgba(96,212,200,0.28)');
    grad.addColorStop(1,'rgba(125,227,248,0.05)');
    wCtx.fillStyle = grad; wCtx.fill();
    wCtx.beginPath();
    for (let x = 0; x <= W; x++) {
      const t2 = x / W;
      const yf = 0.5 + Math.sin(t2*Math.PI*3.2+wPhase)*0.28 + Math.sin(t2*Math.PI*7.1-wPhase*1.4)*0.12 + Math.sin(t2*Math.PI*1.8+wPhase*0.6)*wLoad*0.35;
      const py = H - yf * H * 0.85;
      x === 0 ? wCtx.moveTo(x, py) : wCtx.lineTo(x, py);
    }
    wCtx.strokeStyle = 'rgba(96,212,200,0.85)'; wCtx.lineWidth = 1.2; wCtx.stroke();
    wCtx.restore();
    requestAnimationFrame(waveformTick);
  }

  function buildCodeStream() {
    const inner = document.getElementById('codestream-inner');
    if (!inner) return;
    let rows = '';
    for (let i = 0; i < 18; i++) {
      let line = '';
      for (let j = 0; j < 5; j++) {
        if (Math.random() > 0.55) {
          line += CODE_WORDS[Math.floor(Math.random()*CODE_WORDS.length)] + ' ';
        } else {
          for (let k = 0; k < 4; k++) line += HEX_CHARS[Math.floor(Math.random()*16)];
          line += ' ';
        }
      }
      rows += line.trim() + '\n';
    }
    inner.textContent = rows + rows;
  }

  return {
    init() {
      wCanvas = document.getElementById('waveform-canvas');
      if (wCanvas) {
        const dpr  = window.devicePixelRatio || 1;
        const rect = wCanvas.getBoundingClientRect();
        wCanvas.width  = Math.round((rect.width  || 80) * dpr);
        wCanvas.height = Math.round((rect.height || 26) * dpr);
        wCtx = wCanvas.getContext('2d');
        requestAnimationFrame(waveformTick);
      }
      buildCodeStream();
      setInterval(buildCodeStream, 12000);
    }
  };
})();

/* ═══════════════════════════════════════════════
   V5: MAGNETIC SCROLL ENGINE
   Detects news items entering the center viewport
   zone and enhances their border / backlight.
═══════════════════════════════════════════════ */
const MagneticScroll = (() => {
  let observer = null;

  return {
    init() {
      if (!window.IntersectionObserver) return;
      // Center zone: item must be at least 55% visible within a -18% top/bottom window
      observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.target.classList.contains('focus-target')) return; // focus mode overrides
          if (entry.isIntersecting && entry.intersectionRatio >= 0.55) {
            entry.target.classList.add('magnetic');
          } else {
            entry.target.classList.remove('magnetic');
          }
        });
      }, {
        rootMargin: '-18% 0px -18% 0px',
        threshold:  [0, 0.3, 0.55, 1.0]
      });
    },

    observe(el) {
      if (observer) observer.observe(el);
    },

    unobserve(el) {
      if (observer) observer.unobserve(el);
      el.classList.remove('magnetic');
    }
  };
})();

/* ═══════════════════════════════════════════════
   V5: TAG RESONANCE ENGINE
   Weiyu card background tint drifts based on
   the dominant tag of the current top news item.
═══════════════════════════════════════════════ */
const TagResonance = (() => {
  // tag → [hue, saturation, lightness, alpha]
  const TAG_TINTS = {
    tech:    [210, '75%', '70%', 0.055], // cool blue
    finance: [38,  '80%', '72%', 0.048], // warm amber
    health:  [350, '72%', '78%', 0.05],  // soft pink
    sci:     [270, '65%', '73%', 0.048], // violet
    world:   [165, '60%', '70%', 0.045], // teal
  };

  let _currentTag = null;

  function applyTint(tag) {
    if (tag === _currentTag) return;
    _currentTag = tag;
    const card = document.getElementById('weiyu-card');
    if (!card) return;
    const t = TAG_TINTS[tag];
    if (t) {
      card.style.setProperty('--resonance-h',     t[0]);
      card.style.setProperty('--resonance-s',     t[1]);
      card.style.setProperty('--resonance-l',     t[2]);
      card.style.setProperty('--resonance-alpha', t[3]);
    } else {
      card.style.setProperty('--resonance-alpha', 0);
    }
  }

  return {
    update(tag) { applyTint(tag); },
    reset()     { applyTint(null); }
  };
})();

/* ═══════════════════════════════════════════════
   V5: FOCUS MODE ENGINE
   Long press on news item → "deep analysis" state.
   Peripheral UI retreats; item is spotlit.
═══════════════════════════════════════════════ */
const FocusMode = (() => {
  let _pressTimer  = null;
  let _focused     = false;
  let _targetEl    = null;
  let _startX      = 0, _startY = 0;
  const HOLD_MS    = 520;
  const MOVE_LIMIT = 12;

  function enter(el) {
    if (_focused && _targetEl === el) return;
    _focused = true; _targetEl = el;

    const term  = document.getElementById('terminal');
    const badge = document.getElementById('state-badge');

    // Remove old focus target
    document.querySelectorAll('.focus-target').forEach(e => e.classList.remove('focus-target'));
    document.querySelectorAll('.magnetic').forEach(e => e.classList.remove('magnetic'));

    el.classList.add('focus-target');
    term.classList.add('focus-active');
    document.getElementById('dust-canvas').classList.add('focus-active');

    if (badge) { badge.className = 'state-badge focus'; badge.textContent = 'FOCUS'; }

    // Subtle haptic-less pulse on the item
    el.style.transition = 'transform 0.22s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.22s ease, border-color 0.22s ease, opacity 0.35s ease, filter 0.35s ease';
  }

  function exit() {
    if (!_focused) return;
    _focused = false;

    const term  = document.getElementById('terminal');
    const badge = document.getElementById('state-badge');

    document.querySelectorAll('.focus-target').forEach(e => e.classList.remove('focus-target'));
    term.classList.remove('focus-active');
    document.getElementById('dust-canvas').classList.remove('focus-active');
    _targetEl = null;

    if (badge) {
      const s = FSM.state.toLowerCase();
      badge.className = `state-badge ${s}`;
      badge.textContent = FSM.state;
    }

    // Re-initialize magnetic scroll for all current items
    setTimeout(() => {
      document.querySelectorAll('.news-item').forEach(el => {
        MagneticScroll.unobserve(el);
        MagneticScroll.observe(el);
      });
    }, 80);
  }

  function bindItem(el) {
    function startHold(x, y) {
      _startX = x; _startY = y;
      clearTimeout(_pressTimer);
      _pressTimer = setTimeout(() => enter(el), HOLD_MS);
    }
    function cancelHold(x, y) {
      if (x !== undefined) {
        const dx = Math.abs(x - _startX), dy = Math.abs(y - _startY);
        if (dx > MOVE_LIMIT || dy > MOVE_LIMIT) clearTimeout(_pressTimer);
      } else {
        clearTimeout(_pressTimer);
      }
    }
    function releaseHold() {
      clearTimeout(_pressTimer);
      // Tap (short press) — exit focus if currently in it, else do nothing special
      if (_focused && _targetEl !== el) exit();
      else if (_focused && _targetEl === el) {
        // Second tap on focused item exits focus
        exit();
      }
    }

    el.addEventListener('touchstart', e => {
      const t = e.touches[0];
      startHold(t.clientX, t.clientY);
    }, { passive: true });
    el.addEventListener('touchmove', e => {
      const t = e.touches[0];
      cancelHold(t.clientX, t.clientY);
    }, { passive: true });
    el.addEventListener('touchend',   releaseHold, { passive: true });
    el.addEventListener('touchcancel',() => clearTimeout(_pressTimer), { passive: true });

    // Desktop: right-click or ctrl+click to enter focus
    el.addEventListener('mousedown', e => {
      if (e.button === 0) startHold(e.clientX, e.clientY);
    }, { passive: true });
    el.addEventListener('mousemove', e => cancelHold(e.clientX, e.clientY), { passive: true });
    el.addEventListener('mouseup',   releaseHold, { passive: true });
    el.addEventListener('mouseleave',() => clearTimeout(_pressTimer), { passive: true });
  }

  // Click anywhere outside terminal to exit focus
  document.addEventListener('click', e => {
    if (!_focused) return;
    const term = document.getElementById('terminal');
    if (!term.contains(e.target)) exit();
  }, { passive: true });

  return { bindItem, exit };
})();

/* ═══════════════════════════════════════════════
   V5: RUBBER-BAND ENGINE
   Simulates elastic damping at scroll boundaries.
   When overscrolling at top/bottom, the perspective-
   wrap container stretches then springs back.
═══════════════════════════════════════════════ */
const RubberBand = (() => {
  let _startY  = 0;
  let _ty      = 0;
  let _raf     = null;
  let _active  = false;
  const MAX_TY = 28;
  const DAMP   = 0.38; // resistance factor

  const wrap        = () => document.getElementById('perspective-wrap');
  const rubberTop   = () => document.getElementById('rubber-top');
  const rubberBot   = () => document.getElementById('rubber-bot');

  function setTY(v) {
    _ty = v;
    const w = wrap();
    if (w) w.style.setProperty('--rubber-ty', `${v.toFixed(2)}px`);
    // Show indicator edge
    const rt = rubberTop(), rb = rubberBot();
    if (rt) rt.classList.toggle('visible', v > 4);
    if (rb) rb.classList.toggle('visible', v < -4);
  }

  function springBack() {
    if (!_active) {
      // Spring back with overshoot
      const w = wrap();
      if (w) {
        w.classList.add('rubber-release');
        setTY(0);
        setTimeout(() => w.classList.remove('rubber-release'), 450);
      }
      const rt = rubberTop(), rb = rubberBot();
      if (rt) rt.classList.remove('visible');
      if (rb) rb.classList.remove('visible');
    }
  }

  return {
    init() {
      const body = document.body;

      body.addEventListener('touchstart', e => {
        _startY  = e.touches[0].clientY;
        _active  = true;
        const w  = wrap();
        if (w) w.classList.remove('rubber-release');
      }, { passive: true });

      body.addEventListener('touchmove', e => {
        if (!_active) return;
        const dy    = e.touches[0].clientY - _startY;
        const atTop = window.scrollY <= 0;
        const atBot = (window.scrollY + window.innerHeight) >= (document.body.scrollHeight - 1);

        if ((dy > 0 && atTop) || (dy < 0 && atBot)) {
          // Apply rubber resistance (logarithmic feel)
          const resistance = Math.sign(dy) * Math.min(Math.abs(dy) * DAMP, MAX_TY);
          setTY(resistance);
        } else {
          if (_ty !== 0) setTY(0);
        }
      }, { passive: true });

      body.addEventListener('touchend', () => {
        _active = false;
        springBack();
      }, { passive: true });

      body.addEventListener('touchcancel', () => {
        _active = false;
        springBack();
      }, { passive: true });
    }
  };
})();

/* ═══════════════════════════════════════════════
   V5: PIXEL BURST — "data recombination" effect
   Creates micro pixel fragments on button press,
   scattering in a constrained pattern.
═══════════════════════════════════════════════ */
function pixelBurst(el, event) {
  const rect = el.getBoundingClientRect();
  let cx, cy;
  if (event.touches && event.touches.length > 0) {
    cx = event.touches[0].clientX - rect.left;
    cy = event.touches[0].clientY - rect.top;
  } else {
    cx = (event.clientX || rect.width / 2) - rect.left;
    cy = (event.clientY || rect.height / 2) - rect.top;
  }

  const COLORS = [
    'rgba(255,170,178,0.7)',
    'rgba(125,227,248,0.6)',
    'rgba(96,212,200,0.65)',
    'rgba(255,200,215,0.7)',
  ];

  const N = 7 + Math.floor(Math.random() * 5); // 7-11 pixels
  for (let i = 0; i < N; i++) {
    const px = document.createElement('div');
    px.className = 'pixel-burst';
    px.style.background = COLORS[Math.floor(Math.random() * COLORS.length)];
    px.style.left = (cx - 1.5 + (Math.random()-0.5)*6) + 'px';
    px.style.top  = (cy - 1.5 + (Math.random()-0.5)*6) + 'px';

    // Each pixel scatters in a slightly different direction
    const angle  = (Math.PI * 2 * i / N) + (Math.random()-0.5)*0.5;
    const dist1  = 6 + Math.random() * 10;
    const dist2  = 14 + Math.random() * 14;
    const tx  = Math.cos(angle) * dist1 + (Math.random()-0.5)*4;
    const ty  = Math.sin(angle) * dist1 + (Math.random()-0.5)*4;
    const tx2 = Math.cos(angle) * dist2 + (Math.random()-0.5)*6;
    const ty2 = Math.sin(angle) * dist2 + (Math.random()-0.5)*6;

    px.style.setProperty('--px-tx',  tx.toFixed(1)  + 'px');
    px.style.setProperty('--px-ty',  ty.toFixed(1)  + 'px');
    px.style.setProperty('--px-tx2', tx2.toFixed(1) + 'px');
    px.style.setProperty('--px-ty2', ty2.toFixed(1) + 'px');
    px.style.setProperty('--px-dur', (0.28 + Math.random()*0.12) + 's');
    px.style.setProperty('--px-ease','cubic-bezier(0.22,1,0.36,1)');

    el.appendChild(px);
    px.addEventListener('animationend', () => px.remove(), { once: true });
  }
}

/* ═══════════════════════════════════════════════
   STATE REACTIONS
═══════════════════════════════════════════════ */
FSM.on((state, prev) => {
  const term    = document.getElementById('terminal');
  const badge   = document.getElementById('state-badge');
  const vcore   = document.getElementById('voice-core');
  const vwrap   = document.querySelector('.voice-core-wrap');
  const wcard   = document.getElementById('weiyu-card');
  const wlabel  = document.getElementById('weiyu-label');
  const pstatus = document.getElementById('player-status');

  term.classList.remove('state-idle','state-loading','state-speaking','state-processing','state-standby');
  term.classList.add(`state-${state.toLowerCase()}`);

  // Don't override focus-mode badge
  if (!term.classList.contains('focus-active')) {
    badge.className   = `state-badge ${state.toLowerCase()}`;
    badge.textContent = state;
  }

  vcore.classList.remove('speaking','processing');
  vwrap && vwrap.classList.remove('speaking','processing');
  wcard.classList.remove('speaking');
  wlabel.classList.remove('speaking');
  pstatus.classList.remove('speaking','processing');

  switch (state) {
    case 'LOADING':    BreathEngine.stop(); break;
    case 'IDLE':
      BreathEngine.start();
      pstatus.textContent = 'READY';
      SignalRhythm.stopSpeaking(); SignalRhythm.startIdle();
      break;
    case 'SPEAKING':
      BreathEngine.start();
      vcore.classList.add('speaking'); vwrap && vwrap.classList.add('speaking');
      wcard.classList.add('speaking'); wlabel.classList.add('speaking');
      pstatus.classList.add('speaking'); pstatus.textContent = 'BROADCASTING';
      SignalRhythm.stopIdle(); SignalRhythm.startSpeaking();
      break;
    case 'PROCESSING':
      BreathEngine.start(); BreathEngine.pauseFor(1000);
      vcore.classList.add('processing'); vwrap && vwrap.classList.add('processing');
      pstatus.classList.add('processing'); pstatus.textContent = 'PROCESSING';
      SignalRhythm.stopSpeaking(); SignalRhythm.triggerStorm();
      break;
    case 'STANDBY':
      BreathEngine.start();
      pstatus.textContent = 'STANDBY';
      SignalRhythm.stopSpeaking(); SignalRhythm.stopIdle();
      break;
  }
});

/* ═══════════════════════════════════════════════
   NEURAL REFLEX
═══════════════════════════════════════════════ */
const NeuralReflex = (() => {
  let _timer = null;
  function activate() {
    clearTimeout(_timer);
    const term = document.getElementById('terminal');
    if (term) term.style.setProperty('--neural-bright', '1.010');
  }
  function release() {
    clearTimeout(_timer);
    _timer = setTimeout(() => {
      const term = document.getElementById('terminal');
      if (term) term.style.setProperty('--neural-bright', '1.000');
    }, 80);
  }
  return {
    bind() {
      const term = document.getElementById('terminal');
      if (!term) return;
      ['touchstart','mousedown'].forEach(ev => term.addEventListener(ev, activate, { passive: true }));
      ['touchend','touchcancel','mouseup','mouseleave'].forEach(ev => term.addEventListener(ev, release, { passive: true }));
    }
  };
})();

/* ═══════════════════════════════════════════════
   LOW ACTIVITY
═══════════════════════════════════════════════ */
const LowActivity = (() => {
  let _timer = null, _active = false;
  function enter() {
    if (_active || FSM.state !== 'IDLE') return;
    _active = true;
    const term = document.getElementById('terminal');
    if (term) term.dataset.activity = 'low';
  }
  function exit() {
    if (!_active) return;
    _active = false;
    const term = document.getElementById('terminal');
    if (term) term.dataset.activity = 'normal';
  }
  function reset() {
    exit(); clearTimeout(_timer);
    if (FSM.state === 'IDLE') _timer = setTimeout(enter, CONFIG.lowActivityMs);
  }
  return {
    reset, exit,
    init() {
      ['touchstart','click','keydown','mousemove','scroll'].forEach(ev => {
        document.addEventListener(ev, reset, { passive: true });
      });
    }
  };
})();

/* ═══════════════════════════════════════════════
   SIGNAL RHYTHM
═══════════════════════════════════════════════ */
const SignalRhythm = (() => {
  const BASE_HEIGHTS = [30, 55, 75, 90, 100];
  let _speakTimer = null, _idleTimer = null, _stormTimer = null, _stormRuns = 0;
  function getBars() { return document.querySelectorAll('.signal-bar'); }
  function restoreHeights() { getBars().forEach(b => { b.style.height = ''; b.classList.remove('processing-pulse'); }); }
  function startSpeaking() {
    if (_speakTimer) return;
    let t = 0;
    _speakTimer = setInterval(() => {
      if (FSM.state !== 'SPEAKING') { stopSpeaking(); return; }
      t += 0.22;
      const energy = ((Math.sin(t)+1)/2)*0.65 + ((Math.sin(t*2.8+1)+1)/2)*0.35;
      const activeN = Math.max(2, Math.round(energy * 5));
      getBars().forEach((b, i) => {
        b.classList.remove('active','processing-pulse');
        if (i < activeN) b.classList.add('active');
        b.style.height = `${Math.max(18,Math.min(100,BASE_HEIGHTS[i]+Math.sin(t*(1.4+i*0.4))*8)).toFixed(1)}%`;
      });
    }, 90);
  }
  function stopSpeaking() {
    if (_speakTimer) { clearInterval(_speakTimer); _speakTimer = null; }
    restoreHeights();
    getBars().forEach(b => b.classList.remove('active'));
    [0,1,2,3,4].forEach((_,i) => { if (i>0) getBars()[i]?.classList.add('active'); });
  }
  function startIdle() {
    if (_idleTimer) return;
    _idleTimer = setInterval(() => {
      if (FSM.state !== 'IDLE' && FSM.state !== 'STANDBY') { stopIdle(); return; }
      const bars = getBars();
      bars.forEach((b, i) => {
        if (i === 0) return;
        if (Math.random() > 0.72) b.classList.toggle('active');
        else if (i > 0) b.classList.add('active');
      });
    }, 1000);
  }
  function stopIdle() { if (_idleTimer) { clearInterval(_idleTimer); _idleTimer = null; } }
  function triggerStorm() {
    if (_stormTimer) return;
    _stormRuns = 0;
    _stormTimer = setInterval(() => {
      if (FSM.state !== 'PROCESSING' || _stormRuns > 24) {
        clearInterval(_stormTimer); _stormTimer = null; restoreHeights();
        [0,1,2,3,4].forEach((_,i) => { if (i>0) getBars()[i]?.classList.add('active'); });
        return;
      }
      getBars().forEach(b => {
        b.classList.remove('active');
        b.classList.toggle('processing-pulse', Math.random() > 0.4);
        b.style.height = `${20+Math.random()*80}%`;
      });
      _stormRuns++;
    }, 170);
  }
  return { startSpeaking, stopSpeaking, startIdle, stopIdle, triggerStorm };
})();

/* ═══════════════════════════════════════════════
   IDLE NUDGE
═══════════════════════════════════════════════ */
let _idleNudgeTimer = null, _standbyTimer = null;
function resetIdleTimers() {
  if (_idleNudgeTimer) clearTimeout(_idleNudgeTimer);
  if (_standbyTimer)   clearTimeout(_standbyTimer);
  if (FSM.state === 'STANDBY') FSM.transition('IDLE');

  _idleNudgeTimer = setTimeout(() => {
    if (FSM.state !== 'IDLE') return;
    const core  = document.getElementById('voice-core');
    const wcard = document.getElementById('weiyu-card');
    const wlbl  = document.getElementById('weiyu-label');
    if (core)  { core.classList.add('idle-pulse-anim'); setTimeout(() => core.classList.remove('idle-pulse-anim'), 1000); }
    if (wcard) { wcard.classList.add('idle-nudge'); setTimeout(() => wcard.classList.remove('idle-nudge'), 1200); }
    if (wlbl)  { wlbl.classList.add('idle-badge'); setTimeout(() => wlbl.classList.remove('idle-badge'), 1200); }
  }, CONFIG.idleNudgeMin + Math.random() * (CONFIG.idleNudgeMax - CONFIG.idleNudgeMin));

  _standbyTimer = setTimeout(() => {
    if (FSM.state === 'IDLE') FSM.transition('STANDBY');
  }, CONFIG.standbyDelay);
}

/* ═══════════════════════════════════════════════
   TOUCH FEEDBACK (v5: enhanced with pixel burst)
═══════════════════════════════════════════════ */
function applyTouchFeedback(el) {
  let _pressing = false, _relTimer = null;
  function press(e) {
    _pressing = true;
    el.classList.remove('released');
    el.classList.add('pressed');
    // V5: pixel burst instead of simple ripple
    pixelBurst(el, e);
  }
  function release() {
    if (!_pressing) return;
    _pressing = false;
    el.classList.remove('pressed');
    el.classList.add('released');
    if (_relTimer) clearTimeout(_relTimer);
    _relTimer = setTimeout(() => el.classList.remove('released'), 250);
  }
  el.addEventListener('touchstart',  press,   { passive: true });
  el.addEventListener('touchend',    release, { passive: true });
  el.addEventListener('touchcancel', release, { passive: true });
  el.addEventListener('mousedown',   press,   { passive: true });
  el.addEventListener('mouseup',     release, { passive: true });
}

/* ═══════════════════════════════════════════════
   CLOCK
═══════════════════════════════════════════════ */
function startClock() {
  function update() {
    const now = new Date();
    const h   = String(now.getHours()).padStart(2,'0');
    const m   = String(now.getMinutes()).padStart(2,'0');
    const s   = String(now.getSeconds()).padStart(2,'0');
    const el  = document.getElementById('clock-time');
    if (el) el.textContent = `${h}:${m}:${s}`;
    const sync = document.getElementById('tlp-sync-time');
    if (sync) sync.textContent = `${h}:${m}`;
  }
  update();
  setInterval(update, 1000);
}

/* ═══════════════════════════════════════════════
   TYPE WRITER
═══════════════════════════════════════════════ */
function typeWriter(el, text, onDone) {
  if (!el) return;
  if (el._typeTimer) clearTimeout(el._typeTimer);
  el._typeRun = (el._typeRun || 0) + 1;
  const runId = el._typeRun;

  el.innerHTML = '';
  const cursor = document.createElement('span');
  cursor.className = 'weiyu-cursor';
  let i = 0;
  function next() {
    if (runId !== el._typeRun) return;
    if (i >= text.length) { el.appendChild(cursor); if (onDone) onDone(); return; }
    el.appendChild(document.createTextNode(text[i++]));
    el.appendChild(cursor);
    el._typeTimer = setTimeout(next, 28 + Math.random() * 32);
  }
  next();
}

/* ═══════════════════════════════════════════════
   AUDIO SYSTEM
═══════════════════════════════════════════════ */
let _audioCtx = null, _analyser = null, _source = null, _vizRaf = null;
function initAudio() {
  if (_audioCtx) return;
  try {
    _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    _analyser = _audioCtx.createAnalyser();
    _analyser.fftSize = 64;
    _analyser.connect(_audioCtx.destination);
    const audio = document.getElementById('audio-source');
    _source = _audioCtx.createMediaElementSource(audio);
    _source.connect(_analyser);
  } catch(e) { console.warn('[Audio]', e); }
}
function startVizLoop() {
  if (!_analyser || _vizRaf) return;
  const buf = new Uint8Array(_analyser.frequencyBinCount);
  function loop() {
    _analyser.getByteFrequencyData(buf);
    const energy = buf.slice(0,8).reduce((a,b)=>a+b,0) / (8*255);
    const core   = document.getElementById('voice-core');
    if (core && FSM.state === 'SPEAKING') {
      const glow = 4 + energy * 22, bloom = 4 + energy * 14;
      core.style.boxShadow = [
        `0 0 0 ${(3+energy*5).toFixed(1)}px rgba(255,170,178,${(0.2+energy*0.25).toFixed(2)})`,
        `0 0 ${glow.toFixed(1)}px rgba(255,142,153,${(0.2+energy*0.35).toFixed(2)})`,
        `0 4px ${bloom.toFixed(1)}px rgba(255,142,153,0.2)`,
        'inset 0 1px 2px rgba(255,255,255,0.9)',
      ].join(',');
    }
    _vizRaf = requestAnimationFrame(loop);
  }
  loop();
}
function stopVizLoop() {
  if (_vizRaf) { cancelAnimationFrame(_vizRaf); _vizRaf = null; }
  const core = document.getElementById('voice-core');
  if (core) core.style.boxShadow = '';
}
function formatTime(s) {
  return `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;
}
function togglePlay() {
  initAudio();
  if (_audioCtx?.state === 'suspended') _audioCtx.resume().catch(()=>{});
  const audio  = document.getElementById('audio-source');
  const playI  = document.getElementById('play-icon');
  const pauseI = document.getElementById('pause-icon');
  if (!audio.src || audio.src === window.location.href) {
    if (FSM.state !== 'PROCESSING' && FSM.state !== 'SPEAKING') {
      playI.style.display = 'none'; pauseI.style.display = 'block';
      FSM.transition('PROCESSING'); triggerScanHighlight();
      setTimeout(() => {
        FSM.transition('SPEAKING');
        setTimeout(() => {
          FSM.transition('IDLE');
          playI.style.display = 'block'; pauseI.style.display = 'none';
          clearScanHighlight();
        }, 4000);
      }, 3000);
    } else {
      FSM.transition('IDLE');
      playI.style.display = 'block'; pauseI.style.display = 'none';
      clearScanHighlight();
    }
    return;
  }
  if (audio.paused) {
    triggerGlitch();
    audio.play().then(() => {
      FSM.transition('SPEAKING');
      playI.style.display = 'none'; pauseI.style.display = 'block';
      startVizLoop(); triggerScanHighlight();
    }).catch(()=>{});
  } else {
    audio.pause();
    FSM.transition('IDLE');
    playI.style.display = 'block'; pauseI.style.display = 'none';
    stopVizLoop(); clearScanHighlight();
  }
}

/* ═══════════════════════════════════════════════
   SCAN HIGHLIGHT
═══════════════════════════════════════════════ */
let _scanIdx = 0, _scanTimer = null;
function triggerScanHighlight() {
  const items = document.querySelectorAll('.news-item');
  if (!items.length) return;
  _scanIdx = 0; clearScanHighlight();
  function next() {
    if (_scanIdx >= items.length) {
      setTimeout(() => { clearScanHighlight(); if (FSM.state==='PROCESSING') FSM.transition('SPEAKING'); }, 400);
      return;
    }
    if (_scanIdx > 0) items[_scanIdx-1].classList.remove('processing-scan');
    items[_scanIdx].classList.add('processing-scan');
    _scanIdx++;
    _scanTimer = setTimeout(next, 680);
  }
  next();
}
function clearScanHighlight() {
  if (_scanTimer) { clearTimeout(_scanTimer); _scanTimer = null; }
  document.querySelectorAll('.news-item').forEach(el => el.classList.remove('processing-scan'));
}
function triggerGlitch() {
  const t = document.getElementById('terminal');
  t.classList.add('glitch-active');
  setTimeout(() => t.classList.remove('glitch-active'), 180);
}

/* ═══════════════════════════════════════════════
   DATA SHRED  (v4 retained)
═══════════════════════════════════════════════ */
function triggerDataShred(li) {
  if (FSM.state === 'STANDBY' || FSM.state === 'LOADING') return;
  if (li.classList.contains('glitch-item')) return;
  const wasExpanded = li.classList.contains('expanded');
  li.classList.add('glitch-item','processing-scan');
  setTimeout(() => {
    li.classList.remove('glitch-item','processing-scan');
    if (wasExpanded) {
      li.classList.remove('expanded');
    } else {
      document.querySelectorAll('.news-item.expanded').forEach(o => { if (o !== li) o.classList.remove('expanded'); });
      li.classList.add('expanded');
    }
  }, 180);
}
function makeSummary(text) {
  const shortened = text.length > 48 ? text.slice(0,48)+'…' : text;
  const classify  = ['[CONFIRMED]','[VERIFIED]','[HIGH-CONF]','[LIVE]'][Math.floor(Math.random()*4)];
  return { label: '核心摘要 · INTEL DECODED', classify, text: shortened };
}

/* ═══════════════════════════════════════════════
   AUDIO EVENTS
═══════════════════════════════════════════════ */
(function bindAudioEvents() {
  const audio = document.getElementById('audio-source');
  audio.addEventListener('timeupdate', () => {
    const pct  = audio.duration ? (audio.currentTime / audio.duration) * 100 : 0;
    const fill = document.getElementById('progress-fill');
    fill.style.width = pct + '%';
    pct > 1 ? fill.classList.add('active') : fill.classList.remove('active');
    document.getElementById('time-current').textContent = formatTime(audio.currentTime);
    document.getElementById('time-total').textContent   = formatTime(audio.duration || 0);
  });
  audio.addEventListener('ended', () => {
    document.getElementById('play-icon').style.display  = 'block';
    document.getElementById('pause-icon').style.display = 'none';
    document.getElementById('progress-fill').style.width = '0%';
    stopVizLoop(); clearScanHighlight(); FSM.transition('IDLE');
  });
  audio.addEventListener('error', () => {
    document.getElementById('audio-wrapper').style.display = 'none';
    const tlp = document.getElementById('tactical-link-panel');
    if (tlp) { tlp.style.display = 'block'; tlp.classList.add('visible'); }
  });
})();

/* ═══════════════════════════════════════════════
   PAGINATOR  (v5: integrated with MagneticScroll
   and TagResonance)
═══════════════════════════════════════════════ */
const Paginator = (() => {
  const PER_PAGE = 5;
  let _data = [], _page = 0, _busy = false;
  function totalPages() { return Math.ceil(_data.length / PER_PAGE); }

  function buildItems(pageIdx) {
    const list = document.getElementById('news-list');

    // Unobserve old items
    list.querySelectorAll('.news-item').forEach(el => MagneticScroll.unobserve(el));
    list.innerHTML = '';

    const slice = _data.slice(pageIdx * PER_PAGE, pageIdx * PER_PAGE + PER_PAGE);
    slice.forEach((item, i) => {
      const globalIdx = pageIdx * PER_PAGE + i;
      const li        = document.createElement('li');
      li.className    = 'news-item';
      li.setAttribute('role', 'button');
      const summary = makeSummary(item.text);
      li.innerHTML = `
        <div class="news-main">
          <div class="news-index">${String(globalIdx+1).padStart(2,'0')}</div>
          <div class="news-content">${item.text}</div>
          <div class="news-tag tag-${item.tag}">${item.tag.toUpperCase()}</div>
        </div>
        <div class="news-summary">
          <div class="summary-inner">
            <div class="summary-label">${summary.label}</div>
            <span class="summary-classify">${summary.classify}</span>
            <div class="summary-text">${summary.text}</div>
          </div>
        </div>
        <div class="focus-hint">DEEP·SCAN</div>`;

      applyTouchFeedback(li);
      li.addEventListener('click', () => triggerDataShred(li));
      FocusMode.bindItem(li);
      MagneticScroll.observe(li);
      list.appendChild(li);

      // V5: update tag resonance from first item
      if (i === 0) TagResonance.update(item.tag);
    });
  }

  function buildAll() {
    const list = document.getElementById('news-list');
    list.querySelectorAll('.news-item').forEach(el => MagneticScroll.unobserve(el));
    list.innerHTML = '';
    _data.forEach((item, i) => {
      const li = document.createElement('li');
      li.className = 'news-item';
      li.setAttribute('role', 'button');
      const summary = makeSummary(item.text);
      li.innerHTML = `
        <div class="news-main">
          <div class="news-index">${String(i+1).padStart(2,'0')}</div>
          <div class="news-content">${item.text}</div>
          <div class="news-tag tag-${item.tag}">${item.tag.toUpperCase()}</div>
        </div>
        <div class="news-summary">
          <div class="summary-inner">
            <div class="summary-label">${summary.label}</div>
            <span class="summary-classify">${summary.classify}</span>
            <div class="summary-text">${summary.text}</div>
          </div>
        </div>
        <div class="focus-hint">DEEP·SCAN</div>`;
      applyTouchFeedback(li);
      li.addEventListener('click', () => triggerDataShred(li));
      FocusMode.bindItem(li);
      MagneticScroll.observe(li);
      list.appendChild(li);
    });
    if (_data.length > 0) TagResonance.update(_data[0].tag);
  }

  function updateControls() {
    const pages = totalPages();
    const prev  = document.getElementById('page-prev');
    const next  = document.getElementById('page-next');
    const label = document.getElementById('page-label');
    const dots  = document.getElementById('page-dots');
    prev.classList.toggle('disabled', _page === 0);
    next.classList.toggle('disabled', _page >= pages - 1);
    label.textContent = `${_page+1} / ${pages}`;
    dots.innerHTML = '';
    for (let i = 0; i < pages; i++) {
      const d = document.createElement('div');
      d.className = 'page-dot' + (i === _page ? ' active' : '');
      dots.appendChild(d);
    }
  }

  function goTo(newPage, dir) {
    if (_busy) return;
    const pages = totalPages();
    if (newPage < 0 || newPage >= pages) return;
    _busy = true;
    FocusMode.exit();
    const list    = document.getElementById('news-list');
    const exitCls = dir > 0 ? 'exit-next' : 'exit-prev';
    list.classList.add(exitCls);
    setTimeout(() => {
      list.classList.remove(exitCls);
      _page = newPage; buildItems(_page); updateControls();
      const enterCls = dir > 0 ? 'enter-next' : 'enter-prev';
      list.classList.add(enterCls);
      list.addEventListener('animationend', () => { list.classList.remove(enterCls); _busy = false; }, { once: true });
    }, 200);
  }

  function isMobile() { return window.innerWidth < 600 || /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent); }

  function bindBtns() {
    const prev = document.getElementById('page-prev');
    const next = document.getElementById('page-next');
    const np = prev.cloneNode(true), nn = next.cloneNode(true);
    prev.replaceWith(np); next.replaceWith(nn);
    applyTouchFeedback(np); applyTouchFeedback(nn);
    np.addEventListener('click', () => goTo(_page-1, -1));
    nn.addEventListener('click', () => goTo(_page+1, +1));
  }

  let _resizeTimer = null;
  window.addEventListener('resize', () => {
    clearTimeout(_resizeTimer);
    _resizeTimer = setTimeout(() => { if (_data.length) init(_data); }, 250);
  });

  function init(data) {
    _data = data; _page = 0; _busy = false;
    if (isMobile()) {
      const pages = totalPages();
      document.getElementById('pagination').style.display = pages <= 1 ? 'none' : 'flex';
      buildItems(0); updateControls(); bindBtns();
    } else {
      document.getElementById('pagination').style.display = 'none';
      buildAll();
    }
  }
  return { init };
})();

/* ═══════════════════════════════════════════════
   RENDER UI
═══════════════════════════════════════════════ */
function renderUI(data) {
  const dateEl = document.getElementById('date-display');
  if (dateEl) dateEl.textContent = data.date || DEMO.date;

  const TAG_MAP = [
    { re: /科技|AI|芯片|机器人|大模型|电池|量子|航天|卫星|软件/, tag: 'tech' },
    { re: /财经|经济|股|基金|房|楼市|金融|市场|收入|月入|消费/, tag: 'finance' },
    { re: /健康|医|药|疫|病|研究|实验|临床/,                    tag: 'health' },
    { re: /科学|物理|化学|生物|天文|发现|突破/,                  tag: 'sci' },
  ];
  function guessTag(t) { for (const { re, tag } of TAG_MAP) if (re.test(t)) return tag; return 'world'; }

  const newsData = (data.news || []).map(item => {
    const str   = typeof item === 'string' ? item : (item.text || '');
    const clean = str.replace(/^\d+[、．.]\s*/, '').trim();
    return { text: clean, tag: item.tag || guessTag(clean) };
  });

  const countEl = document.getElementById('news-count');
  if (countEl) countEl.textContent = `${newsData.length}件`;

  Paginator.init(newsData);

  const weiyuEl = document.getElementById('weiyu-text');
  const txt = (data.weiyu || DEMO.weiyu).replace(/^【微语】\s*/, '');
  typeWriter(weiyuEl, txt, () => {});

  const audio     = document.getElementById('audio-source');
  const audioWrap = document.getElementById('audio-wrapper');
  const tlp       = document.getElementById('tactical-link-panel');

  if (data.audio) {
    audio.src = data.audio;
    audioWrap.style.display = 'block';
    if (tlp) tlp.style.display = 'none';
  } else {
    audioWrap.style.display = 'none';
    if (tlp) { tlp.style.display = 'block'; }
  }

  const loadScreen = document.getElementById('loading-screen');
  loadScreen.classList.add('done');
  setTimeout(() => { loadScreen.style.display = 'none'; }, 600);

  FSM.transition('IDLE');
  resetIdleTimers();
  LowActivity.reset();

  document.querySelectorAll('.reveal-item').forEach((el, i) => {
    setTimeout(() => el.classList.add('visible'), 300 + i * 80);
  });

  setTimeout(() => WidgetEngine.init(), 350);
}

/* ═══════════════════════════════════════════════
   INIT
═══════════════════════════════════════════════ */
async function init() {
  startClock();
  document.getElementById('date-display').textContent = DEMO.date;

  ParticleEngine.init();
  TiltEngine.init();
  NeuralReflex.bind();
  LowActivity.init();
  RubberBand.init();
  MagneticScroll.init();

  const vcore = document.getElementById('voice-core');
  applyTouchFeedback(vcore);
  vcore.addEventListener('click', togglePlay);

  BreathEngine.start();

  try {
    const cached = localStorage.getItem(CONFIG.cacheKey);
    if (cached) renderUI(JSON.parse(cached));
    const res  = await fetch(`${CONFIG.api}?t=${Date.now()}`);
    if (!res.ok) throw new Error('API unavailable');
    const json = await res.json();
    const d    = (json.success !== undefined && json.data) ? json.data : (json.data || json);
    localStorage.setItem(CONFIG.cacheKey, JSON.stringify(d));
    renderUI(d);
  } catch(e) {
    console.info('[Schale v5] Using demo data.', e);
    renderUI(DEMO);
  }
}

document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    BreathEngine.stop(); stopVizLoop();
  } else {
    if (FSM.state !== 'LOADING') BreathEngine.start();
    if (FSM.state === 'SPEAKING') startVizLoop();
  }
});

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
